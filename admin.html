<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù„ÙˆØ­Ø© ØªØ­ÙƒÙ… Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„ - Ù…Ù†ØµØ© Ø§Ù„ØªØ¹Ù„Ù…</title>
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background: #f4f7fc;
            min-height: 100vh;
        }

        /* ========== ACCESS DENIED ========== */
        .access-denied {
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 20px;
        }

        .access-denied-card {
            background: white;
            border-radius: 20px;
            padding: 40px;
            width: 100%;
            max-width: 400px;
            text-align: center;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }

        .access-denied-card i {
            font-size: 60px;
            color: #f44336;
            margin-bottom: 20px;
        }

        .access-denied-card h2 {
            color: #333;
            margin-bottom: 15px;
        }

        .access-denied-card p {
            color: #666;
            margin-bottom: 25px;
        }

        .access-denied-card button {
            background: linear-gradient(135deg, #D4AF37, #b4943c);
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .access-denied-card button:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(212,175,55,0.4);
        }

        /* ========== ADMIN DASHBOARD ========== */
        .dashboard-container {
            display: flex;
            min-height: 100vh;
        }

        /* ===== Sidebar ===== */
        .sidebar {
            width: 280px;
            background: linear-gradient(180deg, #1a1f2b 0%, #2d3341 100%);
            color: white;
            padding: 25px;
            position: fixed;
            height: 100vh;
            overflow-y: auto;
            transition: all 0.3s;
            z-index: 1000;
            box-shadow: 4px 0 20px rgba(0,0,0,0.1);
        }

        .sidebar-header {
            text-align: center;
            padding-bottom: 25px;
            border-bottom: 2px solid rgba(212,175,55,0.3);
            margin-bottom: 25px;
        }

        .sidebar-header i {
            font-size: 50px;
            color: #D4AF37;
            margin-bottom: 15px;
        }

        .sidebar-header h3 {
            font-size: 22px;
            margin-bottom: 5px;
        }

        .sidebar-header p {
            color: #D4AF37;
            font-size: 14px;
        }

        .nav-menu {
            list-style: none;
        }

        .nav-item {
            margin-bottom: 10px;
        }

        .nav-link {
            display: flex;
            align-items: center;
            padding: 12px 20px;
            color: #a0a6b5;
            text-decoration: none;
            border-radius: 10px;
            transition: all 0.3s;
            gap: 12px;
            font-size: 16px;
            cursor: pointer;
        }

        .nav-link i {
            width: 24px;
            font-size: 18px;
        }

        .nav-link:hover,
        .nav-link.active {
            background: rgba(212,175,55,0.15);
            color: #D4AF37;
        }

        .nav-link.logout {
            margin-top: 30px;
            color: #f44336;
            border-top: 1px solid #3a4050;
            padding-top: 20px;
        }

        .nav-link.logout:hover {
            background: rgba(244,67,54,0.15);
            color: #f44336;
        }

        /* ===== Main Content ===== */
        .main-content {
            flex: 1;
            margin-right: 280px;
            padding: 30px;
            transition: all 0.3s;
        }

        /* Top Bar */
        .top-bar {
            background: white;
            padding: 20px 30px;
            border-radius: 15px;
            margin-bottom: 30px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.05);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .page-title {
            font-size: 24px;
            color: #333;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .page-title i {
            color: #D4AF37;
        }

        .admin-profile {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .admin-avatar {
            width: 50px;
            height: 50px;
            background: linear-gradient(135deg, #D4AF37, #b4943c);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 20px;
            font-weight: bold;
        }

        .admin-info h4 {
            color: #333;
            margin-bottom: 5px;
        }

        .admin-info p {
            color: #666;
            font-size: 14px;
        }

        /* Stats Cards */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 25px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.05);
            display: flex;
            align-items: center;
            justify-content: space-between;
            transition: all 0.3s;
        }

        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.1);
        }

        .stat-info h3 {
            color: #666;
            font-size: 14px;
            font-weight: normal;
            margin-bottom: 10px;
        }

        .stat-info .stat-number {
            font-size: 32px;
            font-weight: bold;
            color: #333;
        }

        .stat-icon {
            width: 60px;
            height: 60px;
            background: rgba(212,175,55,0.1);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #D4AF37;
            font-size: 24px;
        }

        /* Charts Row */
        .charts-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 25px;
            margin-bottom: 30px;
        }

        .chart-card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.05);
        }

        .chart-card h3 {
            color: #333;
            margin-bottom: 20px;
            font-size: 18px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .chart-card h3 i {
            color: #D4AF37;
        }

        .chart-container {
            height: 300px;
            position: relative;
        }

        /* Tables */
        .table-card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.05);
            margin-bottom: 30px;
        }

        .table-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 15px;
        }

        .table-header h3 {
            color: #333;
            font-size: 18px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .table-actions {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            transition: all 0.3s;
        }

        .btn-primary {
            background: linear-gradient(135deg, #D4AF37, #b4943c);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(212,175,55,0.4);
        }

        .btn-danger {
            background: #f44336;
            color: white;
        }

        .btn-success {
            background: #4CAF50;
            color: white;
        }

        .btn-warning {
            background: #ff9800;
            color: white;
        }

        .btn-info {
            background: #2196F3;
            color: white;
        }

        .btn-sm {
            padding: 6px 12px;
            font-size: 12px;
        }

        .search-box {
            display: flex;
            align-items: center;
            background: #f5f5f5;
            border-radius: 8px;
            padding: 5px 15px;
        }

        .search-box input {
            border: none;
            background: transparent;
            padding: 10px;
            width: 250px;
            outline: none;
        }

        .search-box i {
            color: #666;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th {
            text-align: right;
            padding: 15px 10px;
            background: #f8f9fa;
            color: #333;
            font-weight: 600;
            font-size: 14px;
        }

        td {
            padding: 15px 10px;
            border-bottom: 1px solid #eee;
            color: #666;
        }

        tr:hover {
            background: #f5f5f5;
        }

        .status-badge {
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: bold;
        }

        .status-active {
            background: #d4edda;
            color: #155724;
        }

        .status-inactive {
            background: #f8d7da;
            color: #721c24;
        }

        .action-buttons {
            display: flex;
            gap: 8px;
        }

        /* Modals */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.7);
            z-index: 10000;
            align-items: center;
            justify-content: center;
        }

        .modal.show {
            display: flex;
        }

        .modal-content {
            background: white;
            border-radius: 15px;
            padding: 30px;
            max-width: 500px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            animation: slideIn 0.3s ease;
            border: 3px solid #D4AF37;
        }

        .modal-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #f0f0f0;
        }

        .modal-header h2 {
            color: #333;
            font-size: 22px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .close-modal {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #666;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: #333;
            font-weight: bold;
        }

        .form-control {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
            font-family: inherit;
        }

        .form-control:focus {
            border-color: #D4AF37;
            outline: none;
        }

        .discount-preview {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
            text-align: center;
        }

        .original-price {
            color: #999;
            text-decoration: line-through;
            font-size: 18px;
        }

        .discounted-price {
            color: #4CAF50;
            font-size: 24px;
            font-weight: bold;
        }

        /* Loading Spinner */
        .loading-spinner {
            display: inline-block;
            width: 30px;
            height: 30px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #D4AF37;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        @keyframes slideIn {
            from {
                transform: translateY(-20px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        /* Notifications */
        .admin-notification {
            position: fixed;
            top: 100px;
            left: 20px;
            background: #4CAF50;
            color: white;
            padding: 15px 25px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            gap: 12px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.15);
            z-index: 10001;
            animation: slideInLeft 0.3s ease;
            font-weight: bold;
            max-width: 400px;
        }

        .admin-notification.error {
            background: #f44336;
        }

        .admin-notification.warning {
            background: #ff9800;
        }

        .admin-notification.info {
            background: #2196F3;
        }

        @keyframes slideInLeft {
            from {
                transform: translateX(-100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        /* Responsive */
        @media (max-width: 1024px) {
            .sidebar {
                width: 80px;
                padding: 20px 10px;
            }

            .sidebar-header h3,
            .sidebar-header p,
            .nav-link span {
                display: none;
            }

            .nav-link {
                justify-content: center;
                padding: 12px;
            }

            .nav-link i {
                margin: 0;
                font-size: 20px;
            }

            .main-content {
                margin-right: 80px;
            }

            .charts-row {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 768px) {
            .stats-grid {
                grid-template-columns: 1fr;
            }

            .table-header {
                flex-direction: column;
                align-items: stretch;
            }

            .table-actions {
                flex-direction: column;
            }

            .search-box input {
                width: 100%;
            }

            table {
                display: block;
                overflow-x: auto;
            }
        }
        /* Lesson Management Styles */
.lesson-thumbnail {
    width: 80px;
    height: 45px;
    border-radius: 5px;
    object-fit: cover;
    background: #f0f0f0;
}

.video-preview {
    width: 100%;
    max-height: 300px;
    border-radius: 10px;
    margin: 20px 0;
}

.progress-bar {
    width: 100%;
    height: 30px;
    background: #f0f0f0;
    border-radius: 15px;
    overflow: hidden;
    margin: 15px 0;
}

.progress-fill {
    height: 100%;
    background: linear-gradient(135deg, #D4AF37, #b4943c);
    color: white;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 12px;
    font-weight: bold;
    transition: width 0.3s ease;
}

.upload-area {
    border: 2px dashed #D4AF37;
    border-radius: 10px;
    padding: 30px;
    text-align: center;
    background: #fef9e7;
    cursor: pointer;
    transition: all 0.3s;
    margin-bottom: 20px;
}

.upload-area:hover {
    background: #fef3d9;
    border-color: #b4943c;
}

.upload-area i {
    font-size: 48px;
    color: #D4AF37;
    margin-bottom: 15px;
}

.upload-area h4 {
    color: #333;
    margin-bottom: 5px;
}

.upload-area p {
    color: #666;
    font-size: 14px;
}

.file-info {
    background: #f8f9fa;
    border-radius: 8px;
    padding: 15px;
    margin-top: 15px;
    display: flex;
    align-items: center;
    gap: 15px;
}

.file-info i {
    font-size: 40px;
    color: #D4AF37;
}

.file-details {
    flex: 1;
}

.file-name {
    font-weight: bold;
    color: #333;
    margin-bottom: 5px;
}

.file-size {
    color: #666;
    font-size: 12px;
}

.upload-status {
    display: flex;
    align-items: center;
    gap: 15px;
    margin-top: 15px;
    padding: 15px;
    background: #f8f9fa;
    border-radius: 8px;
}

.status-icon {
    font-size: 24px;
}

.status-icon.success { color: #4CAF50; }
.status-icon.error { color: #f44336; }
.status-icon.uploading { color: #D4AF37; animation: spin 2s linear infinite; }

.status-message {
    flex: 1;
    color: #333;
}

@keyframes spin {
    from { transform: rotate(0deg); }
    to { transform: rotate(360deg); }
}
    </style>
</head>
<body>
    <!-- Access Denied Page -->
    <div id="accessDeniedPage" style="display: none;">
        <div class="access-denied">
            <div class="access-denied-card">
                <i class="fas fa-lock"></i>
                <h2>ÙˆØµÙˆÙ„ ØºÙŠØ± Ù…ØµØ±Ø­</h2>
                <p>Ø¹Ø°Ø±Ø§Ù‹ØŒ Ù‡Ø°Ù‡ Ø§Ù„ØµÙØ­Ø© Ù…Ø®ØµØµØ© Ù„Ù„Ù…Ø³Ø¤ÙˆÙ„ÙŠÙ† ÙÙ‚Ø·. Ø³ÙŠØªÙ… ØªØ­ÙˆÙŠÙ„Ùƒ Ø¥Ù„Ù‰ Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©...</p>
                <button onclick="window.location.href='index.html'">
                    <i class="fas fa-home"></i>
                    Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„Ø±Ø¦ÙŠØ³ÙŠØ©
                </button>
            </div>
        </div>
    </div>

    <!-- Dashboard -->
    <div id="dashboardPage" class="dashboard-container" style="display: none;">
        <!-- Sidebar -->
        <div class="sidebar">
            <div class="sidebar-header">
                <i class="fas fa-graduation-cap"></i>
                <h3>Ù…Ù†ØµØ© Ø§Ù„ØªØ¹Ù„Ù…</h3>
                <p>Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…</p>
            </div>

            <ul class="nav-menu">
                <li class="nav-item">
                    <a class="nav-link active" data-section="dashboard">
                        <i class="fas fa-tachometer-alt"></i>
                        <span>Ù„ÙˆØ­Ø© Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" data-section="users">
                        <i class="fas fa-users"></i>
                        <span>Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" data-section="courses">
                        <i class="fas fa-book"></i>
                        <span>Ø§Ù„ÙƒÙˆØ±Ø³Ø§Øª</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" data-section="sales">
                        <i class="fas fa-chart-line"></i>
                        <span>Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" data-section="discounts">
                        <i class="fas fa-tags"></i>
                        <span>Ø§Ù„Ø®ØµÙˆÙ…Ø§Øª</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" data-section="activities">
                        <i class="fas fa-history"></i>
                        <span>Ø§Ù„Ù†Ø´Ø§Ø·Ø§Øª</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" data-section="lessons">
                        <i class="fas fa-video"></i>
                        <span>Ø§Ù„Ø¯Ø±ÙˆØ³</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link logout" id="logoutBtn">
                        <i class="fas fa-sign-out-alt"></i>
                        <span>ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬</span>
                    </a>
                </li>
            </ul>
        </div>

        <!-- Main Content -->
        <div class="main-content">
            <!-- Top Bar -->
            <div class="top-bar">
                <div class="page-title">
                    <i class="fas fa-tachometer-alt"></i>
                    <span id="currentSectionTitle">Ù„ÙˆØ­Ø© Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª</span>
                </div>
                <div class="admin-profile">
                    <div class="admin-info">
                        <h4 id="adminName">Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„</h4>
                        <p id="adminEmail">admin@example.com</p>
                    </div>
                    <div class="admin-avatar" id="adminAvatar">A</div>
                </div>
            </div>

            <!-- Dynamic Content -->
            <div id="dynamicContent"></div>
        </div>
    </div>

    <!-- Add Course Modal -->
    <div id="addCourseModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>
                    <i class="fas fa-plus-circle"></i>
                    Ø¥Ø¶Ø§ÙØ© ÙƒÙˆØ±Ø³ Ø¬Ø¯ÙŠØ¯
                </h2>
                <button class="close-modal" onclick="closeAddCourseModal()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <form id="addCourseForm">
                <div class="form-group">
                    <label>Ø¹Ù†ÙˆØ§Ù† Ø§Ù„ÙƒÙˆØ±Ø³</label>
                    <input type="text" id="courseTitle" class="form-control" required>
                </div>
                
                <div class="form-group">
                    <label>Ø§Ù„ÙˆØµÙ</label>
                    <textarea id="courseDescription" class="form-control" rows="3" required></textarea>
                </div>
                
                <div class="form-group">
                    <label>Ø§Ù„Ø¬Ø§Ù…Ø¹Ø©</label>
                    <input type="text" id="courseUniversity" class="form-control" required>
                </div>
                
                <div class="form-group">
                    <label>Ø§Ù„Ø³Ø¹Ø±</label>
                    <input type="number" id="coursePrice" class="form-control" min="0" required>
                </div>
                
                <div class="form-group">
                    <label>ØµÙˆØ±Ø© Ø§Ù„ÙƒÙˆØ±Ø³</label>
                    <input type="file" id="courseImage" class="form-control" accept="image/*">
                </div>
                
                <div style="display: flex; gap: 15px; justify-content: center;">
                    <button type="submit" class="btn btn-success">
                        <i class="fas fa-save"></i>
                        Ø¥Ø¶Ø§ÙØ© Ø§Ù„ÙƒÙˆØ±Ø³
                    </button>
                    <button type="button" class="btn btn-danger" onclick="closeAddCourseModal()">
                        <i class="fas fa-times"></i>
                        Ø¥Ù„ØºØ§Ø¡
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Edit Course Modal -->
    <div id="editCourseModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>
                    <i class="fas fa-edit"></i>
                    ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„ÙƒÙˆØ±Ø³
                </h2>
                <button class="close-modal" onclick="closeEditCourseModal()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <form id="editCourseForm">
                <input type="hidden" id="editCourseId">
                
                <div class="form-group">
                    <label>Ø¹Ù†ÙˆØ§Ù† Ø§Ù„ÙƒÙˆØ±Ø³</label>
                    <input type="text" id="editCourseTitle" class="form-control" required>
                </div>
                
                <div class="form-group">
                    <label>Ø§Ù„ÙˆØµÙ</label>
                    <textarea id="editCourseDescription" class="form-control" rows="3" required></textarea>
                </div>
                
                <div class="form-group">
                    <label>Ø§Ù„Ø¬Ø§Ù…Ø¹Ø©</label>
                    <input type="text" id="editCourseUniversity" class="form-control" required>
                </div>
                
                <div class="form-group">
                    <label>Ø§Ù„Ø³Ø¹Ø±</label>
                    <input type="number" id="editCoursePrice" class="form-control" min="0" required>
                </div>
                
                <div style="display: flex; gap: 15px; justify-content: center;">
                    <button type="submit" class="btn btn-success">
                        <i class="fas fa-save"></i>
                        Ø­ÙØ¸ Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª
                    </button>
                    <button type="button" class="btn btn-danger" onclick="closeEditCourseModal()">
                        <i class="fas fa-times"></i>
                        Ø¥Ù„ØºØ§Ø¡
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Discount Modal -->
    <div id="discountModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>
                    <i class="fas fa-tags"></i>
                    Ø¥Ø¶Ø§ÙØ© Ø®ØµÙ…
                </h2>
                <button class="close-modal" onclick="closeDiscountModal()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <form id="discountForm">
                <div class="form-group">
                    <label>Ø§Ù„ÙƒÙˆØ±Ø³</label>
                    <select id="discountCourse" class="form-control" required>
                        <option value="">Ø§Ø®ØªØ± Ø§Ù„ÙƒÙˆØ±Ø³</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label>Ù†Ø³Ø¨Ø© Ø§Ù„Ø®ØµÙ… (%)</label>
                    <input type="number" id="discountPercentage" class="form-control" min="0" max="100" step="1" required>
                </div>
                
                <div class="form-group">
                    <label>ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¨Ø¯Ø§ÙŠØ©</label>
                    <input type="datetime-local" id="discountStartDate" class="form-control" required>
                </div>
                
                <div class="form-group">
                    <label>ØªØ§Ø±ÙŠØ® Ø§Ù„Ù†Ù‡Ø§ÙŠØ©</label>
                    <input type="datetime-local" id="discountEndDate" class="form-control" required>
                </div>
                
                <div class="discount-preview" id="discountPreview">
                    <div class="original-price" id="originalPrice">200 Ø±ÙŠØ§Ù„</div>
                    <div class="discounted-price" id="discountedPrice">150 Ø±ÙŠØ§Ù„</div>
                    <div style="color: #666; margin-top: 10px;">Ø¨Ø¹Ø¯ Ø§Ù„Ø®ØµÙ…</div>
                </div>
                
                <div style="display: flex; gap: 15px; justify-content: center;">
                    <button type="submit" class="btn btn-success">
                        <i class="fas fa-check"></i>
                        Ø­ÙØ¸ Ø§Ù„Ø®ØµÙ…
                    </button>
                    <button type="button" class="btn btn-danger" onclick="closeDiscountModal()">
                        <i class="fas fa-times"></i>
                        Ø¥Ù„ØºØ§Ø¡
                    </button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // ========== CONFIGURATION ==========
        const API_BASE_URL = 'http://localhost:5124';
        const ADMIN_EMAIL = "admin@gmail.com";
        
        // ========== STATE MANAGEMENT ==========
        let authToken = localStorage.getItem('authToken');
        let isAdmin = false;
        let currentSection = 'dashboard';
        let charts = {};
        
        let adminToken = null;
        // ========== CHECK ADMIN ACCESS ==========
        function checkAdminStatus() {
        const userEmail = localStorage.getItem("userEmail");
        const token = localStorage.getItem("authToken");
        const role = localStorage.getItem("userRole");
        
        isAdmin = (userEmail === ADMIN_EMAIL || role === "Admin");
        adminToken = token;
        
        console.log("ğŸ” Admin check:", {
            email: userEmail,
            role: role,
            isAdmin: isAdmin,
            hasToken: !!token
        });
        
        return isAdmin;
    }
    
        // ========== INITIALIZE PAGE ==========
        document.addEventListener('DOMContentLoaded', function() {
            if (checkAdminStatus()) {
                // Show dashboard
                document.getElementById('accessDeniedPage').style.display = 'none';
                document.getElementById('dashboardPage').style.display = 'flex';
                
                // Update admin info
                const adminEmail = localStorage.getItem('userEmail') || ADMIN_EMAIL;
                const adminName = localStorage.getItem('userName') || 'Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„';
                
                document.getElementById('adminEmail').textContent = adminEmail;
                document.getElementById('adminName').textContent = adminName;
                document.getElementById('adminAvatar').textContent = adminName.charAt(0).toUpperCase();
                
                // Load dashboard data
                loadDashboardData();
            } else {
                // Show access denied and redirect after 3 seconds
                document.getElementById('accessDeniedPage').style.display = 'flex';
                document.getElementById('dashboardPage').style.display = 'none';
                
                setTimeout(() => {
                    window.location.href = 'index.html';
                }, 3000);
            }
        });

        // ========== NAVIGATION ==========
        document.querySelectorAll('.nav-link[data-section]').forEach(link => {
            link.addEventListener('click', function(e) {
                e.preventDefault();
                
                // Update active class
                document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active'));
                this.classList.add('active');
                
                // Get section
                const section = this.getAttribute('data-section');
                currentSection = section;
                
                // Update title
                const titles = {
                    'dashboard': 'Ù„ÙˆØ­Ø© Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª',
                    'users': 'Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†',
                    'courses': 'Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ÙƒÙˆØ±Ø³Ø§Øª',
                    'sales': 'Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª',
                    'discounts': 'Ø§Ù„Ø®ØµÙˆÙ…Ø§Øª',
                    'activities': 'Ø§Ù„Ù†Ø´Ø§Ø·Ø§Øª'
                    
                };
                document.getElementById('currentSectionTitle').textContent = titles[section] || section;
                
                // Load section content
                loadSection(section);
            });
        });

        // ========== LOGOUT ==========
        document.getElementById('logoutBtn').addEventListener('click', function() {
    // ÙÙ‚Ø· Ø§Ù„ØªÙˆØ¬ÙŠÙ‡ Ø¥Ù„Ù‰ Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© Ø¨Ø¯ÙˆÙ† Ù…Ø³Ø­ Ø£ÙŠ Ø¨ÙŠØ§Ù†Ø§Øª
    window.location.href = 'index.html';
});

        // ========== LOAD SECTION ==========
        async function loadSection(section) {
            const content = document.getElementById('dynamicContent');
            
            switch(section) {
                case 'dashboard':
                    content.innerHTML = getDashboardHTML();
                    loadDashboardStats();
                    break;
                case 'users':
                    content.innerHTML = getUsersHTML();
                    loadUsers();
                    break;
                case 'courses':
                    content.innerHTML = getCoursesHTML();
                    loadCourses();
                    break;
                case 'sales':
                    content.innerHTML = getSalesHTML();
                    loadSalesData();
                    break;
                case 'discounts':
                    content.innerHTML = getDiscountsHTML();
                    loadDiscounts();
                    loadCoursesForDiscount();
                    break;
                case 'activities':
                    content.innerHTML = getActivitiesHTML();
                    loadActivities();
                    break;
                case 'notifications':
                    content.innerHTML = getNotificationsHTML();
                    loadNotifications();
                    break;
            }
        }

        // ========== LOAD DASHBOARD DATA ==========
        async function loadDashboardData() {
            await loadSection(currentSection);
        }

        // ========== DASHBOARD ==========
        function getDashboardHTML() {
            return `
                <!-- Stats Cards -->
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-info">
                            <h3>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†</h3>
                            <div class="stat-number" id="totalUsers">0</div>
                        </div>
                        <div class="stat-icon">
                            <i class="fas fa-users"></i>
                        </div>
                    </div>
                    
                    <div class="stat-card">
                        <div class="stat-info">
                            <h3>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ÙƒÙˆØ±Ø³Ø§Øª</h3>
                            <div class="stat-number" id="totalCourses">0</div>
                        </div>
                        <div class="stat-icon">
                            <i class="fas fa-book"></i>
                        </div>
                    </div>
                    
                    <div class="stat-card">
                        <div class="stat-info">
                            <h3>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª</h3>
                            <div class="stat-number" id="totalSales">0 Ø±ÙŠØ§Ù„</div>
                        </div>
                        <div class="stat-icon">
                            <i class="fas fa-chart-line"></i>
                        </div>
                    </div>
                    
                    <div class="stat-card">
                        <div class="stat-info">
                            <h3>Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª</h3>
                            <div class="stat-number" id="totalPurchases">0</div>
                        </div>
                        <div class="stat-icon">
                            <i class="fas fa-shopping-cart"></i>
                        </div>
                    </div>
                </div>
                
                <!-- Charts Row -->
                <div class="charts-row">
                    <div class="chart-card">
                        <h3>
                            <i class="fas fa-chart-pie"></i>
                            ØªÙˆØ²ÙŠØ¹ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†
                        </h3>
                        <div class="chart-container">
                            <canvas id="usersChart"></canvas>
                        </div>
                    </div>
                    
                    <div class="chart-card">
                        <h3>
                            <i class="fas fa-chart-bar"></i>
                            Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª Ø§Ù„Ø´Ù‡Ø±ÙŠØ©
                        </h3>
                        <div class="chart-container">
                            <canvas id="salesChart"></canvas>
                        </div>
                    </div>
                </div>
                
                <!-- Recent Activities -->
                <div class="table-card">
                    <div class="table-header">
                        <h3>
                            <i class="fas fa-history"></i>
                            Ø¢Ø®Ø± Ø§Ù„Ù†Ø´Ø§Ø·Ø§Øª
                        </h3>
                    </div>
                    <div id="recentActivities">
                        <div style="text-align: center; padding: 30px;">
                            <div class="loading-spinner"></div>
                            <p style="margin-top: 15px;">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù†Ø´Ø§Ø·Ø§Øª...</p>
                        </div>
                    </div>
                </div>
            `;
        }

        async function loadDashboardStats() {
            try {
                console.log("---------------------------");
                // Load stats from admin endpoints
                const stats = await apiRequest(`/api/admin/stats`);
                console.log(stats);
                const activities = await apiRequest(`/api/admin/activities`);
                console.log(activities);
                const usersSummary = await apiRequest(`/api/admin/users/summary`);
                console.log(usersSummary);
                const coursesSummary = await apiRequest(`/api/admin/courses/summary`);
                console.log(coursesSummary);
                const salesSummary = await apiRequest(`/api/admin/sales/summary`);
                console.log(salesSummary);
                

                // Update stats
                document.getElementById('totalUsers').textContent = stats?.totalUsers || 0;
                document.getElementById('totalCourses').textContent = stats?.totalCourses || 0;
                document.getElementById('totalSales').textContent = (stats?.totalSales || 0) + ' Ø±ÙŠØ§Ù„';
                document.getElementById('totalPurchases').textContent = stats?.totalPurchases || 0;
                
                // Update recent activities
                displayRecentActivities(activities);
                
                // Initialize charts
                initUsersChart(usersSummary);
                initSalesChart(salesSummary);
                
            } catch (error) {
                console.error('Error loading dashboard stats:', error);
                showNotification('ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª', 'error');
            }
        }

        function displayRecentActivities(activities) {
            const container = document.getElementById('recentActivities');
            
            if (!activities || activities.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 30px; color: #666;">
                        <i class="fas fa-history" style="font-size: 40px; margin-bottom: 10px;"></i>
                        <p>Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†Ø´Ø§Ø·Ø§Øª Ø­Ø¯ÙŠØ«Ø©</p>
                    </div>
                `;
                return;
            }
            
            let html = '<table><thead><tr><th>Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</th><th>Ø§Ù„Ù†Ø´Ø§Ø·</th><th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th></tr></thead><tbody>';
            
            activities.slice(0, 10).forEach(activity => {
                html += `
                    <tr>
                        <td>${activity.userName || 'ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ'}</td>
                        <td>${activity.action || activity.description || 'Ù†Ø´Ø§Ø·'}</td>
                        <td>${formatDate(activity.timestamp || activity.createdAt)}</td>
                    </tr>
                `;
            });
            
            html += '</tbody></table>';
            container.innerHTML = html;
        }

        function initUsersChart(data) {
            const ctx = document.getElementById('usersChart').getContext('2d');
            
            if (charts.usersChart) {
                charts.usersChart.destroy();
            }
            
            charts.usersChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ø¬Ø¯Ø¯', 'Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ù†Ø´Ø·ÙŠÙ†', 'Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† ØºÙŠØ± Ù†Ø´Ø·ÙŠÙ†'],
                    datasets: [{
                        data: [
                            data?.newUsers || 0,
                            data?.activeUsers || 0,
                            data?.inactiveUsers || 0
                        ],
                        backgroundColor: ['#4CAF50', '#2196F3', '#f44336'],
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    }
                }
            });
        }

        function initSalesChart(data) {
            const ctx = document.getElementById('salesChart').getContext('2d');
            
            if (charts.salesChart) {
                charts.salesChart.destroy();
            }
            
            const months = ['ÙŠÙ†Ø§ÙŠØ±', 'ÙØ¨Ø±Ø§ÙŠØ±', 'Ù…Ø§Ø±Ø³', 'Ø¥Ø¨Ø±ÙŠÙ„', 'Ù…Ø§ÙŠÙˆ', 'ÙŠÙˆÙ†ÙŠÙˆ', 
                           'ÙŠÙˆÙ„ÙŠÙˆ', 'Ø£ØºØ³Ø·Ø³', 'Ø³Ø¨ØªÙ…Ø¨Ø±', 'Ø£ÙƒØªÙˆØ¨Ø±', 'Ù†ÙˆÙÙ…Ø¨Ø±', 'Ø¯ÙŠØ³Ù…Ø¨Ø±'];
            
            charts.salesChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: months,
                    datasets: [{
                        label: 'Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª',
                        data: data?.monthlySales || Array(12).fill(0),
                        borderColor: '#D4AF37',
                        backgroundColor: 'rgba(212,175,55,0.1)',
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        }
                    }
                }
            });
        }

        // ========== USERS MANAGEMENT ==========
        function getUsersHTML() {
            return `
                <div class="table-card">
                    <div class="table-header">
                        <h3>
                            <i class="fas fa-users"></i>
                            Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†
                        </h3>
                        <div class="table-actions">
                            <div class="search-box">
                                <i class="fas fa-search"></i>
                                <input type="text" id="searchUsers" placeholder="Ø¨Ø­Ø« Ø¹Ù† Ù…Ø³ØªØ®Ø¯Ù…...">
                            </div>
                        </div>
                    </div>
                    
                    <div id="usersList">
                        <div style="text-align: center; padding: 50px;">
                            <div class="loading-spinner"></div>
                            <p style="margin-top: 15px;">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†...</p>
                        </div>
                    </div>
                </div>
            `;
        }

       async function loadUsers() {
    try {
        // Ø§Ø³ØªØ®Ø¯Ù… endpoint Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ø§Ù„Ø¬Ø¯ÙŠØ¯
        const users = await apiRequest('/api/admin/users');
        console.log("ğŸ“‹ Users list:", users);
        
        const container = document.getElementById('usersList');
        
        if (!users || users.length === 0) {
            container.innerHTML = `
                <div style="text-align: center; padding: 50px; color: #666;">
                    <i class="fas fa-users" style="font-size: 50px; margin-bottom: 15px;"></i>
                    <p>Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†</p>
                </div>
            `;
            return;
        }
        
        let html = '<table><thead><tr><th>Ø§Ù„Ø§Ø³Ù…</th><th>Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ</th><th>Ø§Ù„Ø¯ÙˆØ±</th><th>ØªØ§Ø±ÙŠØ® Ø§Ù„ØªØ³Ø¬ÙŠÙ„</th><th>Ø§Ù„Ø­Ø§Ù„Ø©</th><th>Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th></tr></thead><tbody>';
        
        users.forEach(user => {
            const status = user.isActive ? 'Ù†Ø´Ø·' : 'ØºÙŠØ± Ù†Ø´Ø·';
            const statusClass = user.isActive ? 'status-active' : 'status-inactive';
            
            html += `
                <tr>
                    <td>${user.fullName || user.userName || 'ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ'}</td>
                    <td>${user.email}</td>
                    <td>${user.role || 'Ù…Ø³ØªØ®Ø¯Ù…'}</td>
                    <td>${formatDate(user.createdAt)}</td>
                    <td><span class="status-badge ${statusClass}">${status}</span></td>
                    <td class="action-buttons">
                        <button class="btn btn-sm btn-primary" onclick="viewUserCourses('${user.id}')">
                            <i class="fas fa-book"></i>
                        </button>
                        <button class="btn btn-sm btn-info" onclick="viewUserPurchases('${user.id}')">
                            <i class="fas fa-shopping-cart"></i>
                        </button>
                        ${user.role !== 'Admin' ? `
                            <button class="btn btn-sm btn-danger" onclick="deleteUser('${user.id}')">
                                <i class="fas fa-trash"></i>
                            </button>
                        ` : ''}
                    </td>
                </tr>
            `;
        });
        
        html += '</tbody></table>';
        container.innerHTML = html;
        
        // Add search functionality
        const searchInput = document.getElementById('searchUsers');
        if (searchInput) {
            // Remove old listener and add new one
            searchInput.replaceWith(searchInput.cloneNode(true));
            document.getElementById('searchUsers').addEventListener('input', function() {
                const searchTerm = this.value.toLowerCase();
                const rows = document.querySelectorAll('#usersList tbody tr');
                
                rows.forEach(row => {
                    const text = row.textContent.toLowerCase();
                    row.style.display = text.includes(searchTerm) ? '' : 'none';
                });
            });
        }
        
    } catch (error) {
        console.error('âŒ Error loading users:', error);
        showNotification('ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†: ' + error.message, 'error');
        
        document.getElementById('usersList').innerHTML = `
            <div style="text-align: center; padding: 50px; color: #f44336;">
                <i class="fas fa-exclamation-circle" style="font-size: 50px; margin-bottom: 15px;"></i>
                <p>ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†</p>
                <p style="font-size: 14px; color: #999;">${error.message}</p>
            </div>
        `;
    }
}

        // ========== COURSES MANAGEMENT ==========
        function getCoursesHTML() {
            return `
                <div class="table-card">
                    <div class="table-header">
                        <h3>
                            <i class="fas fa-book"></i>
                            Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„ÙƒÙˆØ±Ø³Ø§Øª
                        </h3>
                        <div class="table-actions">
                            <div class="search-box">
                                <i class="fas fa-search"></i>
                                <input type="text" id="searchCourses" placeholder="Ø¨Ø­Ø« Ø¹Ù† ÙƒÙˆØ±Ø³...">
                            </div>
                            <button class="btn btn-primary" onclick="openAddCourseModal()">
                                <i class="fas fa-plus-circle"></i>
                                Ø¥Ø¶Ø§ÙØ© ÙƒÙˆØ±Ø³
                            </button>
                        </div>
                    </div>
                    
                    <div id="coursesList">
                        <div style="text-align: center; padding: 50px;">
                            <div class="loading-spinner"></div>
                            <p style="margin-top: 15px;">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ÙƒÙˆØ±Ø³Ø§Øª...</p>
                        </div>
                    </div>
                </div>
            `;
        }

        async function loadCourses() {
            try {
                const courses = await apiRequest('/api/course');
                
                const container = document.getElementById('coursesList');
                
                if (!courses || courses.length === 0) {
                    container.innerHTML = `
                        <div style="text-align: center; padding: 50px; color: #666;">
                            <i class="fas fa-book" style="font-size: 50px; margin-bottom: 15px;"></i>
                            <p>Ù„Ø§ ØªÙˆØ¬Ø¯ ÙƒÙˆØ±Ø³Ø§Øª</p>
                            <button class="btn btn-primary" onclick="openAddCourseModal()" style="margin-top: 15px;">
                                <i class="fas fa-plus-circle"></i>
                                Ø¥Ø¶Ø§ÙØ© Ø£ÙˆÙ„ ÙƒÙˆØ±Ø³
                            </button>
                        </div>
                    `;
                    return;
                }
                
                let html = '<table><thead><tr><th>Ø§Ù„ØµÙˆØ±Ø©</th><th>Ø§Ù„Ø¹Ù†ÙˆØ§Ù†</th><th>Ø§Ù„Ø¬Ø§Ù…Ø¹Ø©</th><th>Ø§Ù„Ø³Ø¹Ø±</th><th>Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø´ØªØ±ÙƒÙŠÙ†</th><th>Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th></tr></thead><tbody>';
                
                courses.forEach(course => {
                    html += `
                        <tr>
                            <td>
                                <img src="${buildImageUrl(course.imageUrl)}" alt="${course.title}" style="width: 50px; height: 50px; border-radius: 5px; object-fit: cover;">
                            </td>
                            <td>${course.title}</td>
                            <td>${course.university}</td>
                            <td>${course.price} Ø±ÙŠØ§Ù„</td>
                            <td>${course.enrolledCount || 0}</td>
                            <td class="action-buttons">
                                <button class="btn btn-sm btn-primary" onclick="editCourse('${course.id}')">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button class="btn btn-sm btn-warning" onclick="applyDiscount('${course.id}')">
                                    <i class="fas fa-tags"></i>
                                </button>
                                <button class="btn btn-sm btn-danger" onclick="deleteCourse('${course.id}')">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </td>
                        </tr>
                    `;
                });
                
                html += '</tbody></table>';
                container.innerHTML = html;
                
                // Add search functionality
                document.getElementById('searchCourses').addEventListener('input', function() {
                    const searchTerm = this.value.toLowerCase();
                    const rows = document.querySelectorAll('#coursesList tbody tr');
                    
                    rows.forEach(row => {
                        const text = row.textContent.toLowerCase();
                        row.style.display = text.includes(searchTerm) ? '' : 'none';
                    });
                });
                
            } catch (error) {
                console.error('Error loading courses:', error);
                showNotification('ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ÙƒÙˆØ±Ø³Ø§Øª', 'error');
            }
        }

        // ========== SALES MANAGEMENT ==========
        function getSalesHTML() {
            return `
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-info">
                            <h3>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª</h3>
                            <div class="stat-number" id="totalSalesAmount">0 Ø±ÙŠØ§Ù„</div>
                        </div>
                        <div class="stat-icon">
                            <i class="fas fa-chart-line"></i>
                        </div>
                    </div>
                    
                    <div class="stat-card">
                        <div class="stat-info">
                            <h3>Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª</h3>
                            <div class="stat-number" id="totalPurchasesCount">0</div>
                        </div>
                        <div class="stat-icon">
                            <i class="fas fa-shopping-cart"></i>
                        </div>
                    </div>
                    
                    <div class="stat-card">
                        <div class="stat-info">
                            <h3>Ù…ØªÙˆØ³Ø· Ø³Ø¹Ø± Ø§Ù„ÙƒÙˆØ±Ø³</h3>
                            <div class="stat-number" id="averagePrice">0 Ø±ÙŠØ§Ù„</div>
                        </div>
                        <div class="stat-icon">
                            <i class="fas fa-calculator"></i>
                        </div>
                    </div>
                    
                    <div class="stat-card">
                        <div class="stat-info">
                            <h3>Ø£Ø¹Ù„Ù‰ Ù…Ø¨ÙŠØ¹Ø§Øª</h3>
                            <div class="stat-number" id="topSelling">-</div>
                        </div>
                        <div class="stat-icon">
                            <i class="fas fa-trophy"></i>
                        </div>
                    </div>
                </div>
                
                <div class="charts-row">
                    <div class="chart-card">
                        <h3>
                            <i class="fas fa-chart-bar"></i>
                            Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª Ø§Ù„ÙŠÙˆÙ…ÙŠØ©
                        </h3>
                        <div class="chart-container">
                            <canvas id="dailySalesChart"></canvas>
                        </div>
                    </div>
                    
                    <div class="chart-card">
                        <h3>
                            <i class="fas fa-chart-pie"></i>
                            ØªÙˆØ²ÙŠØ¹ Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª Ø­Ø³Ø¨ Ø§Ù„Ø¬Ø§Ù…Ø¹Ø§Øª
                        </h3>
                        <div class="chart-container">
                            <canvas id="universitySalesChart"></canvas>
                        </div>
                    </div>
                </div>
                
                <div class="table-card">
                    <div class="table-header">
                        <h3>
                            <i class="fas fa-history"></i>
                            Ø¢Ø®Ø± Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª
                        </h3>
                    </div>
                    <div id="recentPurchases">
                        <div style="text-align: center; padding: 30px;">
                            <div class="loading-spinner"></div>
                            <p style="margin-top: 15px;">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª...</p>
                        </div>
                    </div>
                </div>
            `;
        }

        async function loadSalesData() {
    try {
        // Ø¬Ù„Ø¨ Ù…Ù„Ø®Øµ Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª (Ù…ØµÙÙˆÙØ© ØªØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ ÙƒØ§Ø¦Ù† ÙˆØ§Ø­Ø¯)
        const salesSummaryArray = await apiRequest('/api/admin/sales/summary');
        console.log("ğŸ“Š Sales summary array:", salesSummaryArray);
        
        // Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ù„ÙƒØ§Ø¦Ù† Ø§Ù„Ø£ÙˆÙ„ Ù…Ù† Ø§Ù„Ù…ØµÙÙˆÙØ©
        const salesSummary = Array.isArray(salesSummaryArray) && salesSummaryArray.length > 0 
            ? salesSummaryArray[0] 
            : {};
        
        console.log("ğŸ“Š Sales summary object:", salesSummary);
        
        // Ø¬Ù„Ø¨ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª
        let purchases = [];
        try {
            const purchasesResponse = await apiRequest('/api/users/purchases');
            console.log("ğŸ“¦ Purchases response:", purchasesResponse);
            
            // Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª Ù…Ù† Ø§Ù„Ø§Ø³ØªØ¬Ø§Ø¨Ø©
            if (Array.isArray(purchasesResponse)) {
                purchases = purchasesResponse;
            } else if (purchasesResponse?.purchases && Array.isArray(purchasesResponse.purchases)) {
                purchases = purchasesResponse.purchases;
            } else if (purchasesResponse?.data && Array.isArray(purchasesResponse.data)) {
                purchases = purchasesResponse.data;
            }
        } catch (e) {
            console.error("âŒ Failed to load purchases:", e);
            // Ù„Ø§ Ù†Ø³ØªØ®Ø¯Ù… Ø¨ÙŠØ§Ù†Ø§Øª ØªØ¬Ø±ÙŠØ¨ÙŠØ©ØŒ ÙÙ‚Ø· Ù†ØªØ±Ùƒ purchases ÙƒÙ…ØµÙÙˆÙØ© ÙØ§Ø±ØºØ©
            purchases = [];
        }
        
        // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª
        updateSalesStats(salesSummary);
        
        // Ø±Ø³Ù… Ø§Ù„Ù…Ø®Ø·Ø·Ø§Øª
        initSalesCharts(salesSummary);
        
        // Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª
        displayRecentPurchases(purchases);
        
    } catch (error) {
        console.error('âŒ Error loading sales data:', error);
        showNotification('ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª: ' + error.message, 'error');
        
        // ÙÙŠ Ø­Ø§Ù„Ø© Ø§Ù„ÙØ´Ù„ØŒ Ù†Ø¸Ù‡Ø± Ø±Ø³Ø§Ù„Ø© Ø®Ø·Ø£ Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù…
        showSalesErrorMessage();
    }
}

// Ø¯Ø§Ù„Ø© Ù„ØªØ­Ø¯ÙŠØ« Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª
function updateSalesStats(salesSummary) {
    console.log("ğŸ“Š Updating stats with:", salesSummary);
    
    // ØªØ­Ø¯ÙŠØ« Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª
    const totalSalesElement = document.getElementById('totalSalesAmount');
    if (totalSalesElement) {
        const totalRevenue = salesSummary?.totalRevenue || 0;
        totalSalesElement.textContent = totalRevenue > 0 ? totalRevenue + ' Ø±ÙŠØ§Ù„' : '0 Ø±ÙŠØ§Ù„';
    }
    
    // ØªØ­Ø¯ÙŠØ« Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª
    const totalPurchasesElement = document.getElementById('totalPurchasesCount');
    if (totalPurchasesElement) {
        totalPurchasesElement.textContent = salesSummary?.totalSales || 0;
    }
    
    // ØªØ­Ø¯ÙŠØ« Ù…ØªÙˆØ³Ø· Ø³Ø¹Ø± Ø§Ù„ÙƒÙˆØ±Ø³
    const averagePriceElement = document.getElementById('averagePrice');
    if (averagePriceElement) {
        const avgPrice = salesSummary?.averageOrderValue || 0;
        averagePriceElement.textContent = avgPrice > 0 ? avgPrice + ' Ø±ÙŠØ§Ù„' : '0 Ø±ÙŠØ§Ù„';
    }
    
    // ØªØ­Ø¯ÙŠØ« Ø£ÙØ¶Ù„ ÙƒÙˆØ±Ø³ Ù…Ø¨ÙŠØ¹Ø§Ù‹
    const topSellingElement = document.getElementById('topSelling');
    if (topSellingElement) {
        topSellingElement.textContent = salesSummary?.topSellingCourse || '-';
    }
}

// Ø¯Ø§Ù„Ø© Ù„Ø±Ø³Ù… Ø§Ù„Ù…Ø®Ø·Ø·Ø§Øª
function initSalesCharts(salesSummary) {
    // Ø±Ø³Ù… Ø§Ù„Ù…Ø®Ø·Ø· Ø§Ù„ÙŠÙˆÙ…ÙŠ
    if (salesSummary?.dailySales && Array.isArray(salesSummary.dailySales)) {
        initDailySalesChart(salesSummary.dailySales);
    } else {
        // Ø¥Ø°Ø§ Ù„Ù… ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§ØªØŒ Ù†Ø®ÙÙŠ Ø§Ù„Ù…Ø®Ø·Ø· Ø£Ùˆ Ù†Ø¸Ù‡Ø± Ø±Ø³Ø§Ù„Ø©
        hideChart('dailySalesChart');
    }
    
    // Ø±Ø³Ù… Ø§Ù„Ù…Ø®Ø·Ø· Ø§Ù„Ø´Ù‡Ø±ÙŠ Ø¥Ø°Ø§ ÙƒØ§Ù† Ù…ÙˆØ¬ÙˆØ¯Ø§Ù‹
    if (salesSummary?.monthlySales && Array.isArray(salesSummary.monthlySales)) {
        initMonthlySalesChart(salesSummary.monthlySales);
    } else {
        hideChart('monthlySalesChart');
    }
}

// Ø¯Ø§Ù„Ø© Ù„Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ù…Ø®Ø·Ø· Ø¥Ø°Ø§ Ù„Ù… ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª
function hideChart(chartId) {
    const canvas = document.getElementById(chartId);
    if (canvas) {
        const container = canvas.parentElement;
        if (container) {
            container.innerHTML = '<div style="text-align: center; padding: 50px; color: #999;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª ÙƒØ§ÙÙŠØ© Ù„Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø®Ø·Ø·</div>';
        }
    }
}

// Ø¯Ø§Ù„Ø© Ù„Ø±Ø³Ù… Ø§Ù„Ù…Ø®Ø·Ø· Ø§Ù„ÙŠÙˆÙ…ÙŠ
function initDailySalesChart(data) {
    const canvas = document.getElementById('dailySalesChart');
    if (!canvas) return;
    
    const ctx = canvas.getContext('2d');
    
    // ØªØ¯Ù…ÙŠØ± Ø§Ù„Ù…Ø®Ø·Ø· Ø§Ù„Ø³Ø§Ø¨Ù‚ Ø¥Ø°Ø§ ÙƒØ§Ù† Ù…ÙˆØ¬ÙˆØ¯Ø§Ù‹
    if (charts.dailySalesChart) {
        charts.dailySalesChart.destroy();
    }
    
    // Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø£Ù† Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…ØµÙÙˆÙØ©
    let chartData = Array.isArray(data) ? data : [];
    
    // Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø£Ù† Ø·ÙˆÙ„ Ø§Ù„Ù…ØµÙÙˆÙØ© 7 Ø£ÙŠØ§Ù…
    while (chartData.length < 7) {
        chartData.push(0);
    }
    chartData = chartData.slice(0, 7);
    
    const days = ['Ø§Ù„Ø£Ø­Ø¯', 'Ø§Ù„Ø¥Ø«Ù†ÙŠÙ†', 'Ø§Ù„Ø«Ù„Ø§Ø«Ø§Ø¡', 'Ø§Ù„Ø£Ø±Ø¨Ø¹Ø§Ø¡', 'Ø§Ù„Ø®Ù…ÙŠØ³', 'Ø§Ù„Ø¬Ù…Ø¹Ø©', 'Ø§Ù„Ø³Ø¨Øª'];
    
    charts.dailySalesChart = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: days,
            datasets: [{
                label: 'Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª',
                data: chartData,
                backgroundColor: '#D4AF37',
                borderRadius: 5
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: false
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        stepSize: 1,
                        callback: function(value) {
                            return Number.isInteger(value) ? value : null;
                        }
                    }
                }
            }
        }
    });
}

// Ø¯Ø§Ù„Ø© Ù„Ø±Ø³Ù… Ø§Ù„Ù…Ø®Ø·Ø· Ø§Ù„Ø´Ù‡Ø±ÙŠ
function initMonthlySalesChart(data) {
    const canvas = document.getElementById('monthlySalesChart');
    if (!canvas) return;
    
    const ctx = canvas.getContext('2d');
    
    if (charts.monthlySalesChart) {
        charts.monthlySalesChart.destroy();
    }
    
    const months = ['ÙŠÙ†Ø§ÙŠØ±', 'ÙØ¨Ø±Ø§ÙŠØ±', 'Ù…Ø§Ø±Ø³', 'Ø¥Ø¨Ø±ÙŠÙ„', 'Ù…Ø§ÙŠÙˆ', 'ÙŠÙˆÙ†ÙŠÙˆ', 
                    'ÙŠÙˆÙ„ÙŠÙˆ', 'Ø£ØºØ³Ø·Ø³', 'Ø³Ø¨ØªÙ…Ø¨Ø±', 'Ø£ÙƒØªÙˆØ¨Ø±', 'Ù†ÙˆÙÙ…Ø¨Ø±', 'Ø¯ÙŠØ³Ù…Ø¨Ø±'];
    
    let chartData = Array.isArray(data) ? data : [];
    
    while (chartData.length < 12) {
        chartData.push(0);
    }
    chartData = chartData.slice(0, 12);
    
    charts.monthlySalesChart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: months,
            datasets: [{
                label: 'Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª',
                data: chartData,
                borderColor: '#D4AF37',
                backgroundColor: 'rgba(212, 175, 55, 0.1)',
                tension: 0.4,
                fill: true
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: false
                }
            }
        }
    });
}

// Ø¯Ø§Ù„Ø© Ù„Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª Ø§Ù„Ø­Ø¯ÙŠØ«Ø©
function displayRecentPurchases(purchases) {
    const container = document.getElementById('recentPurchases');
    
    console.log("âœ… Recent purchases:", purchases);
    
    if (!purchases || purchases.length === 0) {
        container.innerHTML = `
            <div style="text-align: center; padding: 30px; color: #666;">
                <i class="fas fa-shopping-cart" style="font-size: 40px; margin-bottom: 10px;"></i>
                <p>Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø´ØªØ±ÙŠØ§Øª Ø­Ø¯ÙŠØ«Ø©</p>
            </div>
        `;
        return;
    }
    
    let html = '<table><thead><tr><th>Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</th><th>Ø§Ù„ÙƒÙˆØ±Ø³</th><th>Ø§Ù„Ø³Ø¹Ø±</th><th>ØªØ§Ø±ÙŠØ® Ø§Ù„Ø´Ø±Ø§Ø¡</th></tr></thead><tbody>';
    
    purchases.slice(0, 10).forEach(purchase => {
        const userName = purchase.userName || purchase.user?.name || purchase.customerName || 'ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ';
        const userEmail = purchase.userEmail || purchase.user?.email || purchase.customerEmail || '';
        const courseTitle = purchase.courseTitle || purchase.course?.title || purchase.title || 'ÙƒÙˆØ±Ø³';
        const price = purchase.price || purchase.amount || purchase.total || 0;
        const date = purchase.purchaseDate || purchase.date || purchase.createdAt;
        
        html += `
            <tr>
                <td>${userName} ${userEmail ? `<small>(${userEmail})</small>` : ''}</td>
                <td>${courseTitle}</td>
                <td>${price} Ø±ÙŠØ§Ù„</td>
                <td>${formatDate(date)}</td>
            </tr>
        `;
    });
    
    html += '</tbody></table>';
    container.innerHTML = html;
}

// Ø¯Ø§Ù„Ø© Ù„Ø¹Ø±Ø¶ Ø±Ø³Ø§Ù„Ø© Ø®Ø·Ø£ Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª
function showSalesErrorMessage() {
    const elements = [
        'totalSalesAmount',
        'totalPurchasesCount', 
        'averagePrice',
        'topSelling'
    ];
    
    elements.forEach(id => {
        const el = document.getElementById(id);
        if (el) {
            el.textContent = 'Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„';
            el.style.color = '#f44336';
        }
    });
    
    // Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ù…Ø®Ø·Ø·Ø§Øª
    hideChart('dailySalesChart');
    hideChart('monthlySalesChart');
    
    // Ø¹Ø±Ø¶ Ø±Ø³Ø§Ù„Ø© Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª
    const container = document.getElementById('recentPurchases');
    if (container) {
        container.innerHTML = `
            <div style="text-align: center; padding: 30px; color: #f44336;">
                <i class="fas fa-exclamation-circle" style="font-size: 40px; margin-bottom: 10px;"></i>
                <p>ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª</p>
            </div>
        `;
    }
}

// Ø¯Ø§Ù„Ø© Ù…Ø³Ø§Ø¹Ø¯Ø© Ù„ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„ØªØ§Ø±ÙŠØ®
function formatDate(dateString) {
    if (!dateString) return '-';
    
    try {
        const date = new Date(dateString);
        
        // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØµØ­Ø© Ø§Ù„ØªØ§Ø±ÙŠØ®
        if (isNaN(date.getTime())) return '-';
        
        const now = new Date();
        const diffMs = now - date;
        const diffMins = Math.floor(diffMs / 60000);
        const diffHours = Math.floor(diffMs / 3600000);
        const diffDays = Math.floor(diffMs / 86400000);
        
        if (diffMins < 1) return 'Ø§Ù„Ø¢Ù†';
        if (diffMins < 60) return `Ù…Ù†Ø° ${diffMins} Ø¯Ù‚ÙŠÙ‚Ø©`;
        if (diffHours < 24) return `Ù…Ù†Ø° ${diffHours} Ø³Ø§Ø¹Ø©`;
        if (diffDays < 7) return `Ù…Ù†Ø° ${diffDays} ÙŠÙˆÙ…`;
        
        return date.toLocaleDateString('ar-SA');
    } catch (e) {
        return '-';
    }
}

        function initUniversitySalesChart(data) {
            const ctx = document.getElementById('universitySalesChart')?.getContext('2d');
            if (!ctx) return;
            
            if (charts.universitySalesChart) {
                charts.universitySalesChart.destroy();
            }
            
            charts.universitySalesChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: data?.labels || ['Ø¬Ø§Ù…Ø¹Ø© Ø§Ù„Ù…Ù„Ùƒ Ø®Ø§Ù„Ø¯', 'Ø¬Ø§Ù…Ø¹Ø© Ø§Ù„Ù…Ù„Ùƒ ÙÙŠØµÙ„', 'Ø¬Ø§Ù…Ø¹Ø© Ø·ÙŠØ¨Ø©'],
                    datasets: [{
                        data: data?.values || [30, 25, 20],
                        backgroundColor: ['#D4AF37', '#4CAF50', '#2196F3'],
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    }
                }
            });
        }

        // ========== DISCOUNTS MANAGEMENT ==========
        function getDiscountsHTML() {
            return `
                <div class="table-card">
                    <div class="table-header">
                        <h3>
                            <i class="fas fa-tags"></i>
                            Ø§Ù„Ø®ØµÙˆÙ…Ø§Øª Ø§Ù„Ù†Ø´Ø·Ø©
                        </h3>
                        <div class="table-actions">
                            <button class="btn btn-primary" onclick="openDiscountModal()">
                                <i class="fas fa-plus-circle"></i>
                                Ø¥Ø¶Ø§ÙØ© Ø®ØµÙ…
                            </button>
                        </div>
                    </div>
                    
                    <div id="activeDiscounts">
                        <div style="text-align: center; padding: 50px;">
                            <div class="loading-spinner"></div>
                            <p style="margin-top: 15px;">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø®ØµÙˆÙ…Ø§Øª...</p>
                        </div>
                    </div>
                </div>
                
                <div class="table-card">
                    <div class="table-header">
                        <h3>
                            <i class="fas fa-history"></i>
                            Ø§Ù„Ø®ØµÙˆÙ…Ø§Øª Ø§Ù„Ù…Ù†ØªÙ‡ÙŠØ©
                        </h3>
                    </div>
                    
                    <div id="expiredDiscounts">
                        <div style="text-align: center; padding: 50px;">
                            <div class="loading-spinner"></div>
                            <p style="margin-top: 15px;">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø®ØµÙˆÙ…Ø§Øª...</p>
                        </div>
                    </div>
                </div>
            `;
        }

        async function loadDiscounts() {
            // This is a placeholder - you'll need to implement discount endpoints
            const activeContainer = document.getElementById('activeDiscounts');
            const expiredContainer = document.getElementById('expiredDiscounts');
            
            activeContainer.innerHTML = `
                <div style="text-align: center; padding: 30px; color: #666;">
                    <i class="fas fa-tags" style="font-size: 40px; margin-bottom: 10px;"></i>
                    <p>Ù„Ø§ ØªÙˆØ¬Ø¯ Ø®ØµÙˆÙ…Ø§Øª Ù†Ø´Ø·Ø©</p>
                </div>
            `;
            
            expiredContainer.innerHTML = '';
        }

        async function loadCoursesForDiscount() {
            try {
                const courses = await apiRequest('/api/course');
                const select = document.getElementById('discountCourse');
                
                select.innerHTML = '<option value="">Ø§Ø®ØªØ± Ø§Ù„ÙƒÙˆØ±Ø³</option>';
                
                courses.forEach(course => {
                    select.innerHTML += `<option value="${course.id}" data-price="${course.price}">${course.title} - ${course.price} Ø±ÙŠØ§Ù„</option>`;
                });
                
            } catch (error) {
                console.error('Error loading courses for discount:', error);
            }
        }

        // ========== ACTIVITIES MANAGEMENT ==========
        function getActivitiesHTML() {
            return `
                <div class="table-card">
                    <div class="table-header">
                        <h3>
                            <i class="fas fa-history"></i>
                            Ø³Ø¬Ù„ Ø§Ù„Ù†Ø´Ø§Ø·Ø§Øª
                        </h3>
                        <div class="table-actions">
                            <div class="search-box">
                                <i class="fas fa-search"></i>
                                <input type="text" id="searchActivities" placeholder="Ø¨Ø­Ø« ÙÙŠ Ø§Ù„Ù†Ø´Ø§Ø·Ø§Øª...">
                            </div>
                        </div>
                    </div>
                    
                    <div id="activitiesList">
                        <div style="text-align: center; padding: 50px;">
                            <div class="loading-spinner"></div>
                            <p style="margin-top: 15px;">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù†Ø´Ø§Ø·Ø§Øª...</p>
                        </div>
                    </div>
                </div>
            `;
        }

        async function loadActivities() {
            try {
                const activities = await apiRequest('/api/admin/activities');
                
                const container = document.getElementById('activitiesList');
                
                if (!activities || activities.length === 0) {
                    container.innerHTML = `
                        <div style="text-align: center; padding: 50px; color: #666;">
                            <i class="fas fa-history" style="font-size: 50px; margin-bottom: 15px;"></i>
                            <p>Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†Ø´Ø§Ø·Ø§Øª</p>
                        </div>
                    `;
                    return;
                }
                
                let html = '<table><thead><tr><th>Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</th><th>Ø§Ù„Ù†Ø´Ø§Ø·</th><th>Ø§Ù„ØªÙØ§ØµÙŠÙ„</th><th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th></tr></thead><tbody>';
                
                activities.forEach(activity => {
                    html += `
                        <tr>
                            <td>${activity.userName || activity.userEmail || 'ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ'}</td>
                            <td>${activity.action}</td>
                            <td>${activity.details || '-'}</td>
                            <td>${formatDate(activity.timestamp)}</td>
                        </tr>
                    `;
                });
                
                html += '</tbody></table>';
                container.innerHTML = html;
                
                // Add search functionality
                document.getElementById('searchActivities').addEventListener('input', function() {
                    const searchTerm = this.value.toLowerCase();
                    const rows = document.querySelectorAll('#activitiesList tbody tr');
                    
                    rows.forEach(row => {
                        const text = row.textContent.toLowerCase();
                        row.style.display = text.includes(searchTerm) ? '' : 'none';
                    });
                });
                
            } catch (error) {
                console.error('Error loading activities:', error);
                showNotification('ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù†Ø´Ø§Ø·Ø§Øª', 'error');
            }
        }

        
        // ========== COURSE MODALS ==========
        function openAddCourseModal() {
            document.getElementById('addCourseModal').classList.add('show');
        }

        function closeAddCourseModal() {
            document.getElementById('addCourseModal').classList.remove('show');
            document.getElementById('addCourseForm').reset();
        }

        async function editCourse(courseId) {
            try {
                const course = await apiRequest(`/api/course/${courseId}`);
                
                document.getElementById('editCourseId').value = course.id;
                document.getElementById('editCourseTitle').value = course.title;
                document.getElementById('editCourseDescription').value = course.description;
                document.getElementById('editCourseUniversity').value = course.university;
                document.getElementById('editCoursePrice').value = course.price;
                
                document.getElementById('editCourseModal').classList.add('show');
                
            } catch (error) {
                console.error('Error loading course details:', error);
                showNotification('ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ÙƒÙˆØ±Ø³', 'error');
            }
        }

        function closeEditCourseModal() {
            document.getElementById('editCourseModal').classList.remove('show');
            document.getElementById('editCourseForm').reset();
        }

        // ========== ADD COURSE FORM HANDLER ==========
        document.getElementById('addCourseForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const formData = new FormData();
            formData.append('Title', document.getElementById('courseTitle').value);
            formData.append('Description', document.getElementById('courseDescription').value);
            formData.append('University', document.getElementById('courseUniversity').value);
            formData.append('Price', document.getElementById('coursePrice').value);
            
            const imageFile = document.getElementById('courseImage').files[0];
            if (imageFile) {
                formData.append('ImageFile', imageFile);
            }
            
            try {
                await apiRequest('/api/course', {
                    method: 'POST',
                    body: formData,
                    headers: {} // Let browser set content-type for FormData
                });
                
                showNotification('ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„ÙƒÙˆØ±Ø³ Ø¨Ù†Ø¬Ø§Ø­', 'success');
                closeAddCourseModal();
                loadCourses(); // Refresh courses list
                
            } catch (error) {
                console.error('Error adding course:', error);
                showNotification('ÙØ´Ù„ Ø¥Ø¶Ø§ÙØ© Ø§Ù„ÙƒÙˆØ±Ø³', 'error');
            }
        });

        // ========== EDIT COURSE FORM HANDLER ==========
        document.getElementById('editCourseForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const courseId = document.getElementById('editCourseId').value;
            
            const data = {
                Title: document.getElementById('editCourseTitle').value,
                Description: document.getElementById('editCourseDescription').value,
                University: document.getElementById('editCourseUniversity').value,
                Price: parseInt(document.getElementById('editCoursePrice').value)
            };
            
            try {
                await apiRequest(`/api/course/${courseId}`, {
                    method: 'PUT',
                    body: JSON.stringify(data)
                });
                
                showNotification('ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙƒÙˆØ±Ø³ Ø¨Ù†Ø¬Ø§Ø­', 'success');
                closeEditCourseModal();
                loadCourses(); // Refresh courses list
                
            } catch (error) {
                console.error('Error updating course:', error);
                showNotification('ÙØ´Ù„ ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙƒÙˆØ±Ø³', 'error');
            }
        });

        // ========== DISCOUNT MODAL ==========
        function openDiscountModal() {
            document.getElementById('discountModal').classList.add('show');
            loadCoursesForDiscount();
        }

        function closeDiscountModal() {
            document.getElementById('discountModal').classList.remove('show');
            document.getElementById('discountForm').reset();
        }

        // ========== DISCOUNT PREVIEW ==========
        document.getElementById('discountPercentage').addEventListener('input', updateDiscountPreview);
        document.getElementById('discountCourse').addEventListener('change', updateDiscountPreview);

        function updateDiscountPreview() {
            const select = document.getElementById('discountCourse');
            const percentage = parseInt(document.getElementById('discountPercentage').value) || 0;
            
            if (select.selectedIndex > 0) {
                const option = select.options[select.selectedIndex];
                const price = parseInt(option.getAttribute('data-price')) || 0;
                const discounted = price - (price * percentage / 100);
                
                document.getElementById('originalPrice').textContent = price + ' Ø±ÙŠØ§Ù„';
                document.getElementById('discountedPrice').textContent = discounted + ' Ø±ÙŠØ§Ù„';
            }
        }

        // ========== DISCOUNT FORM HANDLER ==========
        document.getElementById('discountForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const courseId = document.getElementById('discountCourse').value;
            const percentage = document.getElementById('discountPercentage').value;
            const startDate = document.getElementById('discountStartDate').value;
            const endDate = document.getElementById('discountEndDate').value;
            
            // This is a placeholder - implement discount endpoint
            showNotification('ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø®ØµÙ… Ø¨Ù†Ø¬Ø§Ø­', 'success');
            closeDiscountModal();
        });

        // ========== USER FUNCTIONS ==========
        window.viewUserCourses = async function(userId) {
            try {
                const courses = await apiRequest(`/api/users/course?userId=${userId}`);
                showNotification(`Ø¹Ø±Ø¶ ÙƒÙˆØ±Ø³Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…: ${courses?.length || 0} ÙƒÙˆØ±Ø³`, 'info');
            } catch (error) {
                console.error('Error loading user courses:', error);
                showNotification('ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ ÙƒÙˆØ±Ø³Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…', 'error');
            }
        };

        window.viewUserPurchases = async function(userId) {
            try {
                const purchases = await apiRequest(`/api/users/purchases?userId=${userId}`);
                showNotification(`Ù…Ø´ØªØ±ÙŠØ§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…: ${purchases?.length || 0} Ø¹Ù…Ù„ÙŠØ©`, 'info');
            } catch (error) {
                console.error('Error loading user purchases:', error);
                showNotification('ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ù…Ø´ØªØ±ÙŠØ§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…', 'error');
            }
        };

        window.deleteUser = async function(userId) {
            if (!confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ØŸ')) return;
            
            try {
                await apiRequest(`/api/users/${userId}`, { method: 'DELETE' });
                showNotification('ØªÙ… Ø­Ø°Ù Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¨Ù†Ø¬Ø§Ø­', 'success');
                loadUsers(); // Refresh users list
            } catch (error) {
                console.error('Error deleting user:', error);
                showNotification('ÙØ´Ù„ Ø­Ø°Ù Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…', 'error');
            }
        };

        window.deleteCourse = async function(courseId) {
            if (!confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„ÙƒÙˆØ±Ø³ØŸ')) return;
            
            try {
                await apiRequest(`/api/course/${courseId}`, { method: 'DELETE' });
                showNotification('ØªÙ… Ø­Ø°Ù Ø§Ù„ÙƒÙˆØ±Ø³ Ø¨Ù†Ø¬Ø§Ø­', 'success');
                loadCourses(); // Refresh courses list
            } catch (error) {
                console.error('Error deleting course:', error);
                showNotification('ÙØ´Ù„ Ø­Ø°Ù Ø§Ù„ÙƒÙˆØ±Ø³', 'error');
            }
        };

        window.applyDiscount = function(courseId) {
            openDiscountModal();
            // Pre-select the course
            setTimeout(() => {
                const select = document.getElementById('discountCourse');
                for (let i = 0; i < select.options.length; i++) {
                    if (select.options[i].value === courseId) {
                        select.selectedIndex = i;
                        updateDiscountPreview();
                        break;
                    }
                }
            }, 500);
        };

        // ========== HELPER FUNCTIONS ==========
        function buildImageUrl(imagePath) {
            if (!imagePath) {
                return 'https://img.freepik.com/free-vector/online-tutorials-concept_52683-37481.jpg?w=740';
            }
            
            if (imagePath.startsWith('http://') || imagePath.startsWith('https://')) {
                return imagePath;
            }
            
            if (imagePath.startsWith('/')) {
                return `${API_BASE_URL}${imagePath}`;
            }
            
            return `${API_BASE_URL}/uploads/courses/${imagePath}`;
        }

        function formatDate(dateString) {
            if (!dateString) return '-';
            
            const date = new Date(dateString);
            
            const now = new Date();
            const diffMs = now - date;
            const diffMins = Math.floor(diffMs / 60000);
            const diffHours = Math.floor(diffMs / 3600000);
            const diffDays = Math.floor(diffMs / 86400000);
            
            if (diffMins < 1) return 'Ø§Ù„Ø¢Ù†';
            if (diffMins < 60) return `Ù…Ù†Ø° ${diffMins} Ø¯Ù‚ÙŠÙ‚Ø©`;
            if (diffHours < 24) return `Ù…Ù†Ø° ${diffHours} Ø³Ø§Ø¹Ø©`;
            if (diffDays < 7) return `Ù…Ù†Ø° ${diffDays} ÙŠÙˆÙ…`;
            
            return date.toLocaleDateString('ar-SA');
        }

        // ========== API REQUEST FUNCTION ==========
       async function apiRequest(endpoint, options = {}) {
    const url = `${API_BASE_URL}${endpoint}`;
    
    const headers = {
        ...options.headers
    };
    console.log("ğŸ“¤ Request headers:", headers);
    
    // Don't set Content-Type for FormData
    if (!(options.body instanceof FormData)) {
        headers['Content-Type'] = 'application/json';
    }
    
    if (authToken) {
        headers['Authorization'] = `Bearer ${authToken}`;
        console.log("ğŸ”‘ Auth token:", headers['Authorization']?.substring(0, 20) + '...');
    }
    
    try {
        const response = await fetch(url, {
            ...options,
            headers
        });
        
        console.log("ğŸ“¡ Response status:", response.status, response.statusText);
        
        // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ù†ÙˆØ¹ Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ù‚Ø¨Ù„ Ø§Ù„Ù‚Ø±Ø§Ø¡Ø©
        const contentType = response.headers.get('content-type');
        const isJson = contentType && contentType.includes('application/json');
        
        // Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ù€ Response Ù…Ø±Ø© ÙˆØ§Ø­Ø¯Ø© ÙÙ‚Ø·
        let responseData;
        
        try {
            if (isJson) {
                responseData = await response.json();
                console.log("âœ… Response data (JSON):", responseData);
            } else {
                responseData = await response.text();
                console.log("âœ… Response data (Text):", responseData?.substring(0, 200) + (responseData?.length > 200 ? '...' : ''));
            }
        } catch (parseError) {
            console.error("âŒ Error parsing response:", parseError);
            responseData = null;
        }
        
        // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø­Ø§Ù„Ø© Ø§Ù„Ø§Ø³ØªØ¬Ø§Ø¨Ø©
        if (!response.ok) {
            let errorMessage = `Ø®Ø·Ø£ ${response.status}`;
            
            if (responseData) {
                if (typeof responseData === 'object') {
                    errorMessage = responseData.message || responseData.title || responseData.error || JSON.stringify(responseData);
                } else if (typeof responseData === 'string') {
                    errorMessage = responseData;
                }
            }
            
            console.error("âŒ API Error:", errorMessage);
            
            if (response.status === 401) {
                showNotification('Ø§Ù†ØªÙ‡Øª Ø§Ù„Ø¬Ù„Ø³Ø©ØŒ ÙŠØ±Ø¬Ù‰ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰', 'error');
                // setTimeout(() => {
                //     window.location.href = 'index.html';
                // }, 2000);
            }
            
            throw new Error(errorMessage);
        }
        
        // Handle 204 No Content
        if (response.status === 204 || !responseData) {
            return null;
        }
        
        return responseData;
        
    } catch (error) {
        console.error('ğŸš¨ API Error:', error);
        showNotification('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„: ' + error.message, 'error');
        throw error;
    }
}

        // ========== NOTIFICATION FUNCTION ==========
        function showNotification(message, type = 'info') {
            // Remove existing notification
            const oldNotification = document.querySelector('.admin-notification');
            if (oldNotification) oldNotification.remove();
            
            const notification = document.createElement('div');
            notification.className = `admin-notification ${type}`;
            
            const icon = type === 'success' ? 'fa-check-circle' : 
                        type === 'error' ? 'fa-exclamation-circle' : 
                        type === 'warning' ? 'fa-exclamation-triangle' : 
                        'fa-info-circle';
            
            notification.innerHTML = `
                <i class="fas ${icon}"></i>
                <span>${message}</span>
            `;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.style.animation = 'slideOutRight 0.3s ease';
                setTimeout(() => {
                    notification.remove();
                }, 300);
            }, 3000);
        }

        // Add animation style
        const style = document.createElement('style');
        style.textContent = `
            @keyframes slideOutRight {
                from { transform: translateX(0); opacity: 1; }
                to { transform: translateX(100%); opacity: 0; }
            }
        `;
        document.head.appendChild(style);

     // ========== LESSONS MANAGEMENT ==========

// Ø¯Ø§Ù„Ø© Ù„Ø¬Ù„Ø¨ Ø¬Ù…ÙŠØ¹ Ø§Ù„ÙƒÙˆØ±Ø³Ø§Øª
async function loadCoursesForLessons() {
    try {
        console.log('ğŸ“¥ Loading courses for lessons...');
        const courses = await apiRequest('/api/Course');
        console.log('âœ… Courses loaded:', courses);
        return Array.isArray(courses) ? courses : [];
    } catch (error) {
        console.error('âŒ Error loading courses for lessons:', error);
        return [];
    }
}

// HTML Ù„Ù‚Ø³Ù… Ø§Ù„Ø¯Ø±ÙˆØ³
function getLessonsHTML() {
    return `
        <div class="table-card">
            <div class="table-header">
                <h3>
                    <i class="fas fa-video"></i>
                    Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¯Ø±ÙˆØ³
                </h3>
                <div class="table-actions">
                    <div class="search-box">
                        <i class="fas fa-search"></i>
                        <input type="text" id="searchLessons" placeholder="Ø¨Ø­Ø« ÙÙŠ Ø§Ù„Ø¯Ø±ÙˆØ³...">
                    </div>
                    <button class="btn btn-primary" onclick="openAddLessonModal()">
                        <i class="fas fa-plus-circle"></i>
                        Ø¥Ø¶Ø§ÙØ© Ø¯Ø±Ø³ Ø¬Ø¯ÙŠØ¯
                    </button>
                </div>
            </div>
            
            <!-- ÙÙ„ØªØ± Ø§Ù„ÙƒÙˆØ±Ø³Ø§Øª -->
            <div style="margin-bottom: 20px; display: flex; gap: 15px; align-items: center;">
                <label style="font-weight: bold; color: #333;">ØªØµÙÙŠØ© Ø­Ø³Ø¨ Ø§Ù„ÙƒÙˆØ±Ø³:</label>
                <select id="courseFilter" class="form-control" style="width: 300px;" onchange="filterLessonsByCourse()">
                    <option value="all">Ø¬Ù…ÙŠØ¹ Ø§Ù„ÙƒÙˆØ±Ø³Ø§Øª</option>
                </select>
            </div>
            
            <!-- Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¯Ø±ÙˆØ³ -->
            <div id="lessonsList">
                <div style="text-align: center; padding: 50px;">
                    <div class="loading-spinner"></div>
                    <p style="margin-top: 15px;">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¯Ø±ÙˆØ³...</p>
                </div>
            </div>
        </div>
    `;
}

// ØªØ­Ù…ÙŠÙ„ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¯Ø±ÙˆØ³
async function loadLessons() {
    try {
        console.log('ğŸ“¥ Loading lessons...');
        const response = await fetch(`${API_BASE_URL}/api/lessons`, {
            method: 'GET',
            headers: {
                'Authorization': `Bearer ${authToken}`,
                'Content-Type': 'application/json',
                'Accept': 'application/json'
            }
        });
        
        if (!response.ok) {
            const errorText = await response.text();
            console.error('âŒ Failed to load lessons:', response.status, errorText);
            throw new Error(`ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¯Ø±ÙˆØ³ (${response.status})`);
        }
        
        const lessons = await response.json();
        console.log('âœ… Lessons loaded:', lessons);
        
        const container = document.getElementById('lessonsList');
        if (!container) return;
        
        // ØªØ­Ù…ÙŠÙ„ Ø§Ù„ÙƒÙˆØ±Ø³Ø§Øª Ù„Ù„Ø¹Ø±Ø¶
        const courses = await loadCoursesForLessons();
        const coursesMap = {};
        courses.forEach(c => coursesMap[c.id] = c);
        
        if (!lessons || lessons.length === 0) {
            container.innerHTML = `
                <div style="text-align: center; padding: 50px; color: #666;">
                    <i class="fas fa-video" style="font-size: 50px; margin-bottom: 15px;"></i>
                    <p>Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¯Ø±ÙˆØ³</p>
                    <button class="btn btn-primary" onclick="openAddLessonModal()" style="margin-top: 15px;">
                        <i class="fas fa-plus-circle"></i>
                        Ø¥Ø¶Ø§ÙØ© Ø£ÙˆÙ„ Ø¯Ø±Ø³
                    </button>
                </div>
            `;
            return;
        }
        
        let html = '<table><thead><tr><th>#</th><th>Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ø¯Ø±Ø³</th><th>Ø§Ù„ÙƒÙˆØ±Ø³</th><th>Ø§Ù„ØªØ±ØªÙŠØ¨</th><th>Ø§Ù„Ù…Ø¯Ø©</th><th>ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¥Ø¶Ø§ÙØ©</th><th>Ø§Ù„ÙÙŠØ¯ÙŠÙˆ</th><th>Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th></tr></thead><tbody>';
        
        lessons.forEach((lesson, index) => {
            const course = coursesMap[lesson.courseId] || { title: 'ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ' };
            const hasVideo = lesson.bunnyVideoId || lesson.videoUrl;
            
            html += `
                <tr data-course-id="${lesson.courseId}">
                    <td>${index + 1}</td>
                    <td>${lesson.title || 'Ø¨Ø¯ÙˆÙ† Ø¹Ù†ÙˆØ§Ù†'}</td>
                    <td>${course.title}</td>
                    <td>${lesson.order || 0}</td>
                    <td>${lesson.duration || '00:00'}</td>
                    <td>${formatDate(lesson.createdAt)}</td>
                    <td>
                        ${hasVideo ? 
                            `<span class="status-badge status-active"><i class="fas fa-check"></i> Ù…ÙˆØ¬ÙˆØ¯</span>` : 
                            `<span class="status-badge status-inactive"><i class="fas fa-times"></i> Ù„Ø§ ÙŠÙˆØ¬Ø¯</span>`
                        }
                    </td>
                    <td class="action-buttons">
                        <button class="btn btn-sm btn-primary" onclick="editLesson('${lesson.id}')" title="ØªØ¹Ø¯ÙŠÙ„">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn btn-sm btn-warning" onclick="uploadVideo('${lesson.id}')" title="Ø±ÙØ¹ ÙÙŠØ¯ÙŠÙˆ">
                            <i class="fas fa-upload"></i>
                        </button>
                        <button class="btn btn-sm btn-info" onclick="previewLesson('${lesson.id}')" title="Ù…Ø¹Ø§ÙŠÙ†Ø©">
                            <i class="fas fa-eye"></i>
                        </button>
                        <button class="btn btn-sm btn-danger" onclick="deleteLesson('${lesson.id}')" title="Ø­Ø°Ù">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                </tr>
            `;
        });
        
        html += '</tbody></table>';
        container.innerHTML = html;
        
        // ØªØ¹Ø¨Ø¦Ø© Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„ÙÙ„ØªØ± Ø¨Ø§Ù„ÙƒÙˆØ±Ø³Ø§Øª
        const filterSelect = document.getElementById('courseFilter');
        if (filterSelect && courses.length > 0) {
            filterSelect.innerHTML = '<option value="all">Ø¬Ù…ÙŠØ¹ Ø§Ù„ÙƒÙˆØ±Ø³Ø§Øª</option>';
            courses.forEach(course => {
                filterSelect.innerHTML += `<option value="${course.id}">${course.title}</option>`;
            });
        }
        
        // Ø¥Ø¶Ø§ÙØ© Ø®Ø§ØµÙŠØ© Ø§Ù„Ø¨Ø­Ø«
        const searchInput = document.getElementById('searchLessons');
        if (searchInput) {
            // Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ù…Ø³ØªÙ…Ø¹ Ø§Ù„Ù‚Ø¯ÙŠÙ… Ø¥Ø°Ø§ ÙˆØ¬Ø¯
            const newSearchInput = searchInput.cloneNode(true);
            searchInput.parentNode.replaceChild(newSearchInput, searchInput);
            
            newSearchInput.addEventListener('input', function() {
                const searchTerm = this.value.toLowerCase();
                const rows = document.querySelectorAll('#lessonsList tbody tr');
                
                rows.forEach(row => {
                    const text = row.textContent.toLowerCase();
                    row.style.display = text.includes(searchTerm) ? '' : 'none';
                });
            });
        }
        
    } catch (error) {
        console.error('âŒ Error loading lessons:', error);
        const container = document.getElementById('lessonsList');
        if (container) {
            container.innerHTML = `
                <div style="text-align: center; padding: 50px; color: #f44336;">
                    <i class="fas fa-exclamation-circle" style="font-size: 50px; margin-bottom: 15px;"></i>
                    <p>ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¯Ø±ÙˆØ³</p>
                    <p style="font-size: 14px; color: #999;">${error.message}</p>
                    <button class="btn btn-primary" onclick="loadLessons()" style="margin-top: 15px;">
                        <i class="fas fa-sync"></i> Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø©
                    </button>
                </div>
            `;
        }
        showNotification('âŒ ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¯Ø±ÙˆØ³: ' + error.message, 'error');
    }
}

// ØªØµÙÙŠØ© Ø§Ù„Ø¯Ø±ÙˆØ³ Ø­Ø³Ø¨ Ø§Ù„ÙƒÙˆØ±Ø³
function filterLessonsByCourse() {
    const filterValue = document.getElementById('courseFilter').value;
    const rows = document.querySelectorAll('#lessonsList tbody tr');
    
    rows.forEach(row => {
        const courseId = row.getAttribute('data-course-id');
        if (filterValue === 'all' || courseId === filterValue) {
            row.style.display = '';
        } else {
            row.style.display = 'none';
        }
    });
}

// Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø¯Ø±Ø³ Ø¨ÙˆØ§Ø³Ø·Ø© ID
async function searchLessonById() {
    const lessonId = document.getElementById('lessonIdSearch').value.trim();
    
    if (!lessonId) {
        showNotification('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ ID Ø§Ù„Ø¯Ø±Ø³', 'warning');
        return;
    }
    
    try {
        showNotification('Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ø¯Ø±Ø³...', 'info');
        const lesson = await apiRequest(`/api/lessons/${lessonId}`);
        
        if (lesson) {
            displayLessonDetails(lesson);
        }
    } catch (error) {
        console.error('Error searching lesson:', error);
        showNotification('Ø§Ù„Ø¯Ø±Ø³ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯', 'error');
    }
}

// Ø¹Ø±Ø¶ ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø¯Ø±Ø³
function displayLessonDetails(lesson) {
    const container = document.getElementById('lessonsList');
    if (!container) return;
    
    container.innerHTML = `
        <h4 style="margin-bottom: 15px; color: #333;">Ù†ØªÙŠØ¬Ø© Ø§Ù„Ø¨Ø­Ø«:</h4>
        <table>
            <thead>
                <tr>
                    <th>ID</th>
                    <th>Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ø¯Ø±Ø³</th>
                    <th>Ø§Ù„ÙˆØµÙ</th>
                    <th>Ø§Ù„ØªØ±ØªÙŠØ¨</th>
                    <th>Ø§Ù„Ù…Ø¯Ø©</th>
                    <th>Ø§Ù„ÙÙŠØ¯ÙŠÙˆ</th>
                    <th>Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td>${lesson.id}</td>
                    <td>${lesson.title || 'Ø¨Ø¯ÙˆÙ† Ø¹Ù†ÙˆØ§Ù†'}</td>
                    <td>${lesson.description || '-'}</td>
                    <td>${lesson.order || 0}</td>
                    <td>${lesson.duration || '00:00'}</td>
                    <td>
                        ${lesson.videoUrl ? 
                            `<button class="btn btn-sm btn-info" onclick="window.open('${lesson.videoUrl}', '_blank')">
                                <i class="fas fa-play"></i> Ù…Ø´Ø§Ù‡Ø¯Ø©
                            </button>` : 
                            'Ù„Ø§ ÙŠÙˆØ¬Ø¯ ÙÙŠØ¯ÙŠÙˆ'}
                    </td>
                    <td class="action-buttons">
                        <button class="btn btn-sm btn-primary" onclick="editLesson('${lesson.id}')">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn btn-sm btn-warning" onclick="uploadVideo('${lesson.id}')">
                            <i class="fas fa-upload"></i>
                        </button>
                        <button class="btn btn-sm btn-info" onclick="previewLesson('${lesson.id}')">
                            <i class="fas fa-eye"></i>
                        </button>
                        <button class="btn btn-sm btn-danger" onclick="deleteLesson('${lesson.id}')">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                </tr>
            </tbody>
        </table>
        <div style="margin-top: 20px; text-align: center;">
            <button class="btn btn-secondary" onclick="loadLessons()">
                <i class="fas fa-arrow-right"></i> Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„Ù‚Ø§Ø¦Ù…Ø©
            </button>
        </div>
    `;
}

// Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ HTML Ù…ÙˆØ¯Ø§Ù„ Ø¥Ø¶Ø§ÙØ© Ø¯Ø±Ø³
function getAddLessonModalHTML() {
    // Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ù…ÙˆØ¯Ø§Ù„ Ø§Ù„Ù‚Ø¯ÙŠÙ… Ø¥Ø°Ø§ ÙˆØ¬Ø¯
    const oldModal = document.getElementById('addLessonModal');
    if (oldModal) oldModal.remove();
    
    const modalHTML = `
        <div id="addLessonModal" class="modal">
            <div class="modal-content" style="max-width: 500px;">
                <div class="modal-header">
                    <h2>
                        <i class="fas fa-plus-circle"></i>
                        Ø¥Ø¶Ø§ÙØ© Ø¯Ø±Ø³ Ø¬Ø¯ÙŠØ¯
                    </h2>
                    <button class="close-modal" onclick="closeAddLessonModal()">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                
                <div class="modal-body">
                    <div id="addLessonError" style="display: none; background: #ffebee; color: #f44336; padding: 10px; border-radius: 5px; margin-bottom: 15px;"></div>
                    
                    <form id="addLessonForm">
                        <div class="form-group">
                            <label>Ø§Ø®ØªØ± Ø§Ù„ÙƒÙˆØ±Ø³ <span style="color: #f44336;">*</span></label>
                            <select id="lessonCourseId" class="form-control" required>
                                <option value="">-- Ø§Ø®ØªØ± Ø§Ù„ÙƒÙˆØ±Ø³ --</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label>Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ø¯Ø±Ø³ <span style="color: #f44336;">*</span></label>
                            <input type="text" id="lessonTitle" class="form-control" required>
                        </div>
                        
                        <div class="form-group">
                            <label>ÙˆØµÙ Ø§Ù„Ø¯Ø±Ø³</label>
                            <textarea id="lessonDescription" class="form-control" rows="3"></textarea>
                        </div>
                        
                        <div class="form-group">
                            <label>Ø§Ù„ØªØ±ØªÙŠØ¨</label>
                            <input type="number" id="lessonOrder" class="form-control" min="1" value="1">
                        </div>
                        
                        <div class="form-group">
                            <label>Ù…Ø¯Ø© Ø§Ù„ÙÙŠØ¯ÙŠÙˆ</label>
                            <input type="text" id="lessonDuration" class="form-control" placeholder="Ù…Ø«Ø§Ù„: 15:30">
                        </div>
                        
                        <div style="display: flex; gap: 15px; justify-content: center; margin-top: 20px;">
                            <button type="submit" class="btn btn-success">
                                <i class="fas fa-save"></i> Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¯Ø±Ø³
                            </button>
                            <button type="button" class="btn btn-danger" onclick="closeAddLessonModal()">
                                <i class="fas fa-times"></i> Ø¥Ù„ØºØ§Ø¡
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    `;
    
    document.body.insertAdjacentHTML('beforeend', modalHTML);
}

// ÙØªØ­ Ù…ÙˆØ¯Ø§Ù„ Ø¥Ø¶Ø§ÙØ© Ø¯Ø±Ø³
async function openAddLessonModal() {
    getAddLessonModalHTML();
    
    const modal = document.getElementById('addLessonModal');
    if (!modal) return;
    
    // ØªØ­Ù…ÙŠÙ„ Ø§Ù„ÙƒÙˆØ±Ø³Ø§Øª
    try {
        const courses = await loadCoursesForLessons();
        const select = document.getElementById('lessonCourseId');
        
        select.innerHTML = '<option value="">-- Ø§Ø®ØªØ± Ø§Ù„ÙƒÙˆØ±Ø³ --</option>';
        if (courses && courses.length > 0) {
            courses.forEach(course => {
                select.innerHTML += `<option value="${course.id}">${course.title}</option>`;
            });
        } else {
            select.innerHTML += '<option value="" disabled>Ù„Ø§ ØªÙˆØ¬Ø¯ ÙƒÙˆØ±Ø³Ø§Øª Ù…ØªØ§Ø­Ø©</option>';
        }
        
        modal.classList.add('show');
        
        // Ø¥Ø¶Ø§ÙØ© Ù…Ø¹Ø§Ù„Ø¬ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ù†Ù…ÙˆØ°Ø¬
        const form = document.getElementById('addLessonForm');
        // Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ù…Ø³ØªÙ…Ø¹ Ø§Ù„Ù‚Ø¯ÙŠÙ… Ø¥Ø°Ø§ ÙˆØ¬Ø¯
        const newForm = form.cloneNode(true);
        form.parentNode.replaceChild(newForm, form);
        newForm.addEventListener('submit', handleAddLessonSubmit);
        
    } catch (error) {
        console.error('Error loading courses:', error);
        showNotification('ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ÙƒÙˆØ±Ø³Ø§Øª', 'error');
    }
}

// Ø¥ØºÙ„Ø§Ù‚ Ù…ÙˆØ¯Ø§Ù„ Ø¥Ø¶Ø§ÙØ© Ø¯Ø±Ø³
function closeAddLessonModal() {
    const modal = document.getElementById('addLessonModal');
    if (modal) {
        modal.classList.remove('show');
    }
}

// Ù…Ø¹Ø§Ù„Ø¬Ø© Ø¥Ø¶Ø§ÙØ© Ø¯Ø±Ø³ Ø¬Ø¯ÙŠØ¯
async function handleAddLessonSubmit(e) {
    e.preventDefault();
    
    const courseId = document.getElementById('lessonCourseId').value;
    const title = document.getElementById('lessonTitle').value.trim();
    const description = document.getElementById('lessonDescription').value.trim();
    const order = parseInt(document.getElementById('lessonOrder').value) || 1;
    const duration = document.getElementById('lessonDuration').value.trim();
    
    if (!courseId || !title) {
        showNotification('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©', 'error');
        return;
    }
    
    // Ø§Ø³ØªØ®Ø¯Ø§Ù… FormData Ø¨Ø¯Ù„Ø§Ù‹ Ù…Ù† JSON
    const formData = new FormData();
    formData.append('Title', title);
    formData.append('Description', description || '');
    formData.append('CourseId', parseInt(courseId));
    formData.append('Order', order);
    formData.append('Duration', duration || '00:00');
    
    console.log('ğŸ“¤ Sending FormData:');
    for (let pair of formData.entries()) {
        console.log(pair[0] + ':', pair[1]);
    }
    
    try {
        showNotification('Ø¬Ø§Ø±ÙŠ Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¯Ø±Ø³...', 'info');
        
        const response = await fetch(`${API_BASE_URL}/api/lessons`, {
            method: 'POST',
            headers: {
                'Authorization': `Bearer ${authToken}`
                // Ù„Ø§ ØªØ¶Ù Content-Type Ù‡Ù†Ø§ - Ø§Ù„Ù…ØªØµÙØ­ Ø³ÙŠØ¶ÙŠÙÙ‡Ø§ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹
            },
            body: formData
        });
        
        if (!response.ok) {
            const errorText = await response.text();
            console.error('âŒ Error response:', errorText);
            throw new Error(errorText || 'ÙØ´Ù„ Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¯Ø±Ø³');
        }
        
        const result = await response.json();
        console.log('âœ… Success:', result);
        
        showNotification('âœ… ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¯Ø±Ø³ Ø¨Ù†Ø¬Ø§Ø­', 'success');
        closeAddLessonModal();
        loadLessons();
        
    } catch (error) {
        console.error('âŒ Error:', error);
        showNotification('âŒ ' + error.message, 'error');
    }
}

// ÙØªØ­ Ù…ÙˆØ¯Ø§Ù„ ØªØ¹Ø¯ÙŠÙ„ Ø¯Ø±Ø³
async function editLesson(lessonId) {
    try {
        console.log('ğŸ“¥ Loading lesson for edit:', lessonId);
        const lesson = await apiRequest(`/api/lessons/${lessonId}`);
        console.log('âœ… Lesson loaded:', lesson);
        
        // Ø¥Ù†Ø´Ø§Ø¡ Ù…ÙˆØ¯Ø§Ù„ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„
        const editModalHTML = `
            <div id="editLessonModal" class="modal show">
                <div class="modal-content" style="max-width: 500px;">
                    <div class="modal-header">
                        <h2>
                            <i class="fas fa-edit"></i>
                            ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø¯Ø±Ø³
                        </h2>
                        <button class="close-modal" onclick="closeEditLessonModal()">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    
                    <div id="editLessonError" style="display: none; background: #ffebee; color: #f44336; padding: 10px; border-radius: 5px; margin-bottom: 15px;"></div>
                    
                    <form id="editLessonForm">
                        <input type="hidden" id="editLessonId" value="${lesson.id}">
                        
                        <div class="form-group">
                            <label>Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ø¯Ø±Ø³</label>
                            <input type="text" id="editLessonTitle" class="form-control" value="${lesson.title || ''}" required>
                        </div>
                        
                        <div class="form-group">
                            <label>ÙˆØµÙ Ø§Ù„Ø¯Ø±Ø³</label>
                            <textarea id="editLessonDescription" class="form-control" rows="3">${lesson.description || ''}</textarea>
                        </div>
                        
                        <div class="form-group">
                            <label>Ø§Ù„ØªØ±ØªÙŠØ¨</label>
                            <input type="number" id="editLessonOrder" class="form-control" value="${lesson.order || 1}">
                        </div>
                        
                        <div class="form-group">
                            <label>Ù…Ø¯Ø© Ø§Ù„ÙÙŠØ¯ÙŠÙˆ</label>
                            <input type="text" id="editLessonDuration" class="form-control" value="${lesson.duration || ''}">
                        </div>
                        
                        <div style="display: flex; gap: 15px; justify-content: center; margin-top: 20px;">
                            <button type="submit" class="btn btn-success">
                                <i class="fas fa-save"></i> Ø­ÙØ¸ Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª
                            </button>
                            <button type="button" class="btn btn-danger" onclick="closeEditLessonModal()">
                                <i class="fas fa-times"></i> Ø¥Ù„ØºØ§Ø¡
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        `;
        
        // Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ù…ÙˆØ¯Ø§Ù„ Ø§Ù„Ù‚Ø¯ÙŠÙ… Ø¥Ø°Ø§ ÙˆØ¬Ø¯
        const oldModal = document.getElementById('editLessonModal');
        if (oldModal) oldModal.remove();
        
        // Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…ÙˆØ¯Ø§Ù„ Ø§Ù„Ø¬Ø¯ÙŠØ¯
        document.body.insertAdjacentHTML('beforeend', editModalHTML);
        
        // Ø¥Ø¶Ø§ÙØ© Ù…Ø¹Ø§Ù„Ø¬ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ù†Ù…ÙˆØ°Ø¬
        const form = document.getElementById('editLessonForm');
        form.addEventListener('submit', handleUpdateLessonSubmit);
        
    } catch (error) {
        console.error('Error loading lesson:', error);
        showNotification('ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¯Ø±Ø³', 'error');
    }
}

// Ù…Ø¹Ø§Ù„Ø¬Ø© ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¯Ø±Ø³
async function handleUpdateLessonSubmit(e) {
    e.preventDefault();
    
    const errorDiv = document.getElementById('editLessonError');
    if (errorDiv) errorDiv.style.display = 'none';
    
    const lessonId = document.getElementById('editLessonId').value;
    const title = document.getElementById('editLessonTitle').value.trim();
    const description = document.getElementById('editLessonDescription').value.trim();
    const order = parseInt(document.getElementById('editLessonOrder').value) || 1;
    const duration = document.getElementById('editLessonDuration').value.trim();
    
    if (!title) {
        showNotification('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ø¯Ø±Ø³', 'error');
        return;
    }
    
    const lessonData = {
        title: title,
        description: description || null,
        order: order,
        duration: duration || null
    };
    
    console.log('ğŸ“¤ Updating lesson:', lessonId, lessonData);
    
    try {
        showNotification('Ø¬Ø§Ø±ÙŠ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¯Ø±Ø³...', 'info');
        
        const response = await fetch(`${API_BASE_URL}/api/lessons/${lessonId}`, {
            method: 'PUT',
            headers: {
                'Authorization': `Bearer ${authToken}`,
                'Content-Type': 'application/json',
                'Accept': 'application/json'
            },
            body: JSON.stringify(lessonData)
        });
        
        const responseText = await response.text();
        console.log('ğŸ“¥ Response status:', response.status);
        console.log('ğŸ“¥ Response body:', responseText);
        
        if (!response.ok) {
            let errorMessage = 'ÙØ´Ù„ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¯Ø±Ø³';
            
            try {
                if (responseText) {
                    const errorJson = JSON.parse(responseText);
                    if (errorJson.errors) {
                        const errors = [];
                        for (const field in errorJson.errors) {
                            errors.push(`${field}: ${errorJson.errors[field].join(', ')}`);
                        }
                        errorMessage = errors.join(' | ');
                    } else if (errorJson.title) {
                        errorMessage = errorJson.title;
                    } else if (errorJson.message) {
                        errorMessage = errorJson.message;
                    }
                }
            } catch (parseError) {
                errorMessage = responseText || `Ø®Ø·Ø£ ${response.status}`;
            }
            
            throw new Error(errorMessage);
        }
        
        showNotification('âœ… ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¯Ø±Ø³ Ø¨Ù†Ø¬Ø§Ø­', 'success');
        closeEditLessonModal();
        
        setTimeout(() => {
            loadLessons();
        }, 500);
        
    } catch (error) {
        console.error('âŒ Error updating lesson:', error);
        
        if (errorDiv) {
            errorDiv.textContent = error.message;
            errorDiv.style.display = 'block';
        }
        
        showNotification('âŒ ' + error.message, 'error');
    }
}

// Ø¥ØºÙ„Ø§Ù‚ Ù…ÙˆØ¯Ø§Ù„ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„
function closeEditLessonModal() {
    const modal = document.getElementById('editLessonModal');
    if (modal) {
        modal.remove();
    }
}

// Ø±ÙØ¹ ÙÙŠØ¯ÙŠÙˆ Ù„Ø¯Ø±Ø³
async function uploadVideo(lessonId) {
    // Ø¥Ù†Ø´Ø§Ø¡ Ù…ÙˆØ¯Ø§Ù„ Ø±ÙØ¹ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ
    const uploadModalHTML = `
        <div id="uploadVideoModal" class="modal show">
            <div class="modal-content" style="max-width: 500px;">
                <div class="modal-header">
                    <h2>
                        <i class="fas fa-upload"></i>
                        Ø±ÙØ¹ ÙÙŠØ¯ÙŠÙˆ Ù„Ù„Ø¯Ø±Ø³
                    </h2>
                    <button class="close-modal" onclick="closeUploadModal()">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                
                <div class="modal-body">
                    <div id="uploadError" style="display: none; background: #ffebee; color: #f44336; padding: 10px; border-radius: 5px; margin-bottom: 15px;"></div>
                    
                    <div class="form-group">
                        <label>Ø§Ø®ØªØ± Ù…Ù„Ù Ø§Ù„ÙÙŠØ¯ÙŠÙˆ</label>
                        
                        <!-- Ù…Ù†Ø·Ù‚Ø© Ø§Ù„Ø±ÙØ¹ -->
                        <div class="upload-area" onclick="document.getElementById('lessonVideoUpload').click()">
                            <i class="fas fa-cloud-upload-alt"></i>
                            <h4>Ø§Ù†Ù‚Ø± Ù„Ø§Ø®ØªÙŠØ§Ø± Ù…Ù„Ù</h4>
                            <p>MP4, WebM, Ogg (Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ù‚ØµÙ‰ 500MB)</p>
                        </div>
                        
                        <input type="file" id="lessonVideoUpload" accept="video/*" style="display: none;" 
                               onchange="handleVideoUploadSelect(event, '${lessonId}')">
                        
                        <!-- Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù…Ù„Ù Ø§Ù„Ù…Ø­Ø¯Ø¯ -->
                        <div id="uploadFileInfo" style="display: none;" class="file-info">
                            <i class="fas fa-video"></i>
                            <div class="file-details">
                                <div class="file-name" id="uploadFileName"></div>
                                <div class="file-size" id="uploadFileSize"></div>
                            </div>
                        </div>
                        
                        <!-- Ø´Ø±ÙŠØ· Ø§Ù„ØªÙ‚Ø¯Ù… -->
                        <div id="uploadProgress" style="display: none;">
                            <div class="progress-bar">
                                <div class="progress-fill" id="uploadProgressFill">0%</div>
                            </div>
                        </div>
                        
                        <!-- Ø²Ø± Ø§Ù„Ø±ÙØ¹ -->
                        <button id="startUploadBtn" class="btn btn-success" style="width: 100%; margin-top: 20px; display: none;" 
                                onclick="startVideoUpload('${lessonId}')">
                            <i class="fas fa-upload"></i> Ø¨Ø¯Ø¡ Ø§Ù„Ø±ÙØ¹
                        </button>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    // Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ù…ÙˆØ¯Ø§Ù„ Ø§Ù„Ù‚Ø¯ÙŠÙ… Ø¥Ø°Ø§ ÙˆØ¬Ø¯
    const oldModal = document.getElementById('uploadVideoModal');
    if (oldModal) oldModal.remove();
    
    // Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…ÙˆØ¯Ø§Ù„ Ø§Ù„Ø¬Ø¯ÙŠØ¯
    document.body.insertAdjacentHTML('beforeend', uploadModalHTML);
}

// Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ø®ØªÙŠØ§Ø± Ù…Ù„Ù Ù„Ù„Ø±ÙØ¹
function handleVideoUploadSelect(event, lessonId) {
    const file = event.target.files[0];
    if (!file) return;
    
    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù
    const validTypes = ['video/mp4', 'video/webm', 'video/ogg', 'video/quicktime'];
    if (!validTypes.includes(file.type)) {
        showNotification('Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù ØºÙŠØ± Ù…Ø¯Ø¹ÙˆÙ…. Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø±ÙØ¹ Ù…Ù„Ù ÙÙŠØ¯ÙŠÙˆ MP4, WebM Ø£Ùˆ Ogg', 'error');
        document.getElementById('lessonVideoUpload').value = '';
        return;
    }
    
    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø­Ø¬Ù… Ø§Ù„Ù…Ù„Ù (500MB ÙƒØ­Ø¯ Ø£Ù‚ØµÙ‰)
    const maxSize = 500 * 1024 * 1024; // 500MB in bytes
    if (file.size > maxSize) {
        showNotification('Ø­Ø¬Ù… Ø§Ù„Ù…Ù„Ù ÙƒØ¨ÙŠØ± Ø¬Ø¯Ø§Ù‹. Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ù‚ØµÙ‰ 500MB', 'error');
        document.getElementById('lessonVideoUpload').value = '';
        return;
    }
    
    // Ø¹Ø±Ø¶ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù…Ù„Ù
    document.getElementById('uploadFileName').textContent = file.name;
    document.getElementById('uploadFileSize').textContent = formatFileSize(file.size);
    document.getElementById('uploadFileInfo').style.display = 'flex';
    
    // Ø¥Ø¸Ù‡Ø§Ø± Ø²Ø± Ø¨Ø¯Ø¡ Ø§Ù„Ø±ÙØ¹
    document.getElementById('startUploadBtn').style.display = 'block';
    
    // Ø­ÙØ¸ Ø§Ù„Ù…Ù„Ù Ù„Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù… Ù„Ø§Ø­Ù‚Ø§Ù‹
    window.selectedVideoFile = file;
}

// Ø¨Ø¯Ø¡ Ø±ÙØ¹ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ
async function startVideoUpload(lessonId) {
    const file = window.selectedVideoFile;
    const errorDiv = document.getElementById('uploadError');
    
    if (!file) {
        showNotification('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ø®ØªÙŠØ§Ø± Ù…Ù„Ù Ø£ÙˆÙ„Ø§Ù‹', 'warning');
        return;
    }
    
    // Ø¥Ø¸Ù‡Ø§Ø± Ø´Ø±ÙŠØ· Ø§Ù„ØªÙ‚Ø¯Ù…
    document.getElementById('uploadProgress').style.display = 'block';
    document.getElementById('startUploadBtn').disabled = true;
    if (errorDiv) errorDiv.style.display = 'none';
    
    try {
        // Ø¥Ù†Ø´Ø§Ø¡ FormData Ù„Ø±ÙØ¹ Ø§Ù„Ù…Ù„Ù ÙÙ‚Ø·
        const formData = new FormData();
        formData.append('file', file);
        
        console.log('ğŸ“¤ Uploading video for lesson:', lessonId);
        console.log('ğŸ“ File:', file.name, file.size, file.type);
        
        updateUploadProgress(10);
        
        const response = await fetch(`${API_BASE_URL}/api/admin/${lessonId}/upload-video`, {
            method: 'POST',
            headers: {
                'Authorization': `Bearer ${authToken}`
            },
            body: formData
        });
        
        updateUploadProgress(80);
        
        const responseText = await response.text();
        console.log('ğŸ“¥ Response status:', response.status);
        console.log('ğŸ“¥ Response body:', responseText);
        
        if (!response.ok) {
            let errorMessage = 'ÙØ´Ù„ Ø±ÙØ¹ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ';
            try {
                if (responseText) {
                    const errorJson = JSON.parse(responseText);
                    errorMessage = errorJson.message || errorJson.title || errorMessage;
                }
            } catch (e) {
                errorMessage = responseText || errorMessage;
            }
            throw new Error(errorMessage);
        }
        
        let result;
        try {
            result = responseText ? JSON.parse(responseText) : { message: 'ØªÙ… Ø§Ù„Ø±ÙØ¹ Ø¨Ù†Ø¬Ø§Ø­' };
        } catch (e) {
            result = { message: responseText || 'ØªÙ… Ø§Ù„Ø±ÙØ¹ Ø¨Ù†Ø¬Ø§Ø­' };
        }
        
        console.log('âœ… Upload success:', result);
        
        updateUploadProgress(100);
        
        showNotification('âœ… ØªÙ… Ø±ÙØ¹ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ Ø¨Ù†Ø¬Ø§Ø­', 'success');
        
        setTimeout(() => {
            closeUploadModal();
            loadLessons();
        }, 2000);
        
    } catch (error) {
        console.error('âŒ Error uploading video:', error);
        
        if (errorDiv) {
            errorDiv.textContent = error.message;
            errorDiv.style.display = 'block';
        }
        
        showNotification('âŒ ÙØ´Ù„ Ø±ÙØ¹ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ: ' + error.message, 'error');
        document.getElementById('startUploadBtn').disabled = false;
        document.getElementById('uploadProgress').style.display = 'none';
    }
}

// ØªØ­Ø¯ÙŠØ« Ø´Ø±ÙŠØ· Ø§Ù„ØªÙ‚Ø¯Ù…
function updateUploadProgress(percent) {
    const progressFill = document.getElementById('uploadProgressFill');
    if (progressFill) {
        progressFill.style.width = percent + '%';
        progressFill.textContent = percent + '%';
    }
}

// Ø¥ØºÙ„Ø§Ù‚ Ù…ÙˆØ¯Ø§Ù„ Ø§Ù„Ø±ÙØ¹
function closeUploadModal() {
    const modal = document.getElementById('uploadVideoModal');
    if (modal) {
        modal.remove();
    }
    window.selectedVideoFile = null;
}

// Ù…Ø¹Ø§ÙŠÙ†Ø© Ø§Ù„Ø¯Ø±Ø³
async function previewLesson(lessonId) {
    try {
        const lesson = await apiRequest(`/api/lessons/${lessonId}`);
        
        const previewHTML = `
            <div id="previewLessonModal" class="modal show">
                <div class="modal-content" style="max-width: 800px;">
                    <div class="modal-header">
                        <h2>
                            <i class="fas fa-eye"></i>
                            Ù…Ø¹Ø§ÙŠÙ†Ø© Ø§Ù„Ø¯Ø±Ø³: ${lesson.title || 'Ø¨Ø¯ÙˆÙ† Ø¹Ù†ÙˆØ§Ù†'}
                        </h2>
                        <button class="close-modal" onclick="closePreviewModal()">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    
                    <div class="modal-body">
                        ${lesson.videoUrl ? `
                            <div style="margin-bottom: 20px;">
                                <video class="video-preview" controls>
                                    <source src="${lesson.videoUrl}" type="video/mp4">
                                    Ù…ØªØµÙØ­Ùƒ Ù„Ø§ ÙŠØ¯Ø¹Ù… ØªØ´ØºÙŠÙ„ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ
                                </video>
                            </div>
                        ` : `
                            <div style="text-align: center; padding: 40px; background: #f8f9fa; border-radius: 10px; margin-bottom: 20px;">
                                <i class="fas fa-video-slash" style="font-size: 50px; color: #999;"></i>
                                <p style="margin-top: 15px; color: #666;">Ù„Ø§ ÙŠÙˆØ¬Ø¯ ÙÙŠØ¯ÙŠÙˆ Ù„Ù‡Ø°Ø§ Ø§Ù„Ø¯Ø±Ø³</p>
                                <button class="btn btn-primary" onclick="uploadVideo('${lesson.id}'); closePreviewModal();">
                                    <i class="fas fa-upload"></i> Ø±ÙØ¹ ÙÙŠØ¯ÙŠÙˆ
                                </button>
                            </div>
                        `}
                        
                        <div style="background: #f8f9fa; padding: 20px; border-radius: 10px;">
                            <h4 style="color: #333; margin-bottom: 10px;">ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø¯Ø±Ø³</h4>
                            <p><strong>ID:</strong> ${lesson.id}</p>
                            <p><strong>Ø§Ù„Ø¹Ù†ÙˆØ§Ù†:</strong> ${lesson.title}</p>
                            <p><strong>Ø§Ù„ÙˆØµÙ:</strong> ${lesson.description || 'Ù„Ø§ ÙŠÙˆØ¬Ø¯ ÙˆØµÙ'}</p>
                            <p><strong>Ø§Ù„ØªØ±ØªÙŠØ¨:</strong> ${lesson.order || 0}</p>
                            <p><strong>Ø§Ù„Ù…Ø¯Ø©:</strong> ${lesson.duration || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}</p>
                            ${lesson.videoUrl ? `
                                <p><strong>Ø±Ø§Ø¨Ø· Ø§Ù„ÙÙŠØ¯ÙŠÙˆ:</strong> 
                                    <a href="${lesson.videoUrl}" target="_blank" style="color: #D4AF37; word-break: break-all;">
                                        ${lesson.videoUrl}
                                    </a>
                                </p>
                            ` : ''}
                        </div>
                    </div>
                </div>
            </div>
        `;
        
        const oldModal = document.getElementById('previewLessonModal');
        if (oldModal) oldModal.remove();
        
        document.body.insertAdjacentHTML('beforeend', previewHTML);
        
    } catch (error) {
        console.error('Error previewing lesson:', error);
        showNotification('ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¯Ø±Ø³ Ù„Ù„Ù…Ø¹Ø§ÙŠÙ†Ø©', 'error');
    }
}

// Ø¥ØºÙ„Ø§Ù‚ Ù…ÙˆØ¯Ø§Ù„ Ø§Ù„Ù…Ø¹Ø§ÙŠÙ†Ø©
function closePreviewModal() {
    const modal = document.getElementById('previewLessonModal');
    if (modal) {
        modal.remove();
    }
}

// Ø­Ø°Ù Ø¯Ø±Ø³
async function deleteLesson(lessonId) {
    if (!confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ø¯Ø±Ø³ØŸ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„ØªØ±Ø§Ø¬Ø¹ Ø¹Ù† Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡.')) {
        return;
    }
    
    try {
        showNotification('Ø¬Ø§Ø±ÙŠ Ø­Ø°Ù Ø§Ù„Ø¯Ø±Ø³...', 'info');
        
        const response = await fetch(`${API_BASE_URL}/api/lessons/${lessonId}`, {
            method: 'DELETE',
            headers: {
                'Authorization': `Bearer ${authToken}`,
                'Content-Type': 'application/json',
                'Accept': 'application/json'
            }
        });
        
        if (!response.ok) {
            const errorText = await response.text();
            let errorMessage = 'ÙØ´Ù„ Ø­Ø°Ù Ø§Ù„Ø¯Ø±Ø³';
            try {
                if (errorText) {
                    const errorJson = JSON.parse(errorText);
                    errorMessage = errorJson.message || errorJson.title || errorMessage;
                }
            } catch (e) {
                errorMessage = errorText || errorMessage;
            }
            throw new Error(errorMessage);
        }
        
        showNotification('âœ… ØªÙ… Ø­Ø°Ù Ø§Ù„Ø¯Ø±Ø³ Ø¨Ù†Ø¬Ø§Ø­', 'success');
        loadLessons();
        
    } catch (error) {
        console.error('âŒ Error deleting lesson:', error);
        showNotification('âŒ ÙØ´Ù„ Ø­Ø°Ù Ø§Ù„Ø¯Ø±Ø³: ' + error.message, 'error');
    }
}

// Ø¥Ø¹Ø§Ø¯Ø© ØªØ±ØªÙŠØ¨ Ø§Ù„Ø¯Ø±ÙˆØ³
async function reorderLessons(orders) {
    try {
        const response = await fetch(`${API_BASE_URL}/api/lessons/reorder`, {
            method: 'POST',
            headers: {
                'Authorization': `Bearer ${authToken}`,
                'Content-Type': 'application/json',
                'Accept': 'application/json'
            },
            body: JSON.stringify(orders)
        });
        
        if (!response.ok) {
            throw new Error('ÙØ´Ù„ Ø¥Ø¹Ø§Ø¯Ø© ØªØ±ØªÙŠØ¨ Ø§Ù„Ø¯Ø±ÙˆØ³');
        }
        
        showNotification('âœ… ØªÙ… Ø¥Ø¹Ø§Ø¯Ø© ØªØ±ØªÙŠØ¨ Ø§Ù„Ø¯Ø±ÙˆØ³ Ø¨Ù†Ø¬Ø§Ø­', 'success');
        loadLessons();
        
    } catch (error) {
        console.error('âŒ Error reordering lessons:', error);
        showNotification('âŒ ÙØ´Ù„ Ø¥Ø¹Ø§Ø¯Ø© ØªØ±ØªÙŠØ¨ Ø§Ù„Ø¯Ø±ÙˆØ³', 'error');
    }
}

// ØªÙ†Ø³ÙŠÙ‚ Ø­Ø¬Ù… Ø§Ù„Ù…Ù„Ù
function formatFileSize(bytes) {
    if (bytes === 0) return '0 Bytes';
    
    const k = 1024;
    const sizes = ['Bytes', 'KB', 'MB', 'GB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    
    return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
}

// ========== UPDATE SECTION LOADER ==========
// ØªØ­Ø¯ÙŠØ« Ø¯Ø§Ù„Ø© loadSection
const originalLoadSection = window.loadSection || function() {};

window.loadSection = function(section) {
    const content = document.getElementById('dynamicContent');
    
    if (section === 'lessons') {
        content.innerHTML = getLessonsHTML();
        setTimeout(() => {
            loadLessons();
        }, 100);
    } else {
        originalLoadSection(section);
    }
};

// ========== EXPOSE FUNCTIONS GLOBALLY ==========
window.searchLessonById = searchLessonById;
window.openAddLessonModal = openAddLessonModal;
window.closeAddLessonModal = closeAddLessonModal;
window.editLesson = editLesson;
window.closeEditLessonModal = closeEditLessonModal;
window.previewLesson = previewLesson;
window.closePreviewModal = closePreviewModal;
window.deleteLesson = deleteLesson;
window.uploadVideo = uploadVideo;
window.handleVideoUploadSelect = handleVideoUploadSelect;
window.startVideoUpload = startVideoUpload;
window.closeUploadModal = closeUploadModal;
window.filterLessonsByCourse = filterLessonsByCourse;
window.reorderLessons = reorderLessons;
window.loadLessons = loadLessons;
        // Make functions globally available
        window.openAddCourseModal = openAddCourseModal;
        window.closeAddCourseModal = closeAddCourseModal;
        window.editCourse = editCourse;
        window.closeEditCourseModal = closeEditCourseModal;
        window.openDiscountModal = openDiscountModal;
        window.closeDiscountModal = closeDiscountModal;
        window.applyDiscount = applyDiscount;
        window.deleteUser = deleteUser;
        window.deleteCourse = deleteCourse;
        window.viewUserCourses = viewUserCourses;
        window.viewUserPurchases = viewUserPurchases;
        
    </script>
    <div id="addLessonModal" class="modal">
    <!-- Ø³ÙŠØªÙ… ØªØ¹Ø¨Ø¦ØªÙ‡ Ø¯ÙŠÙ†Ø§Ù…ÙŠÙƒÙŠØ§Ù‹ -->
</div>

<div id="editLessonModal" class="modal">
    <!-- Ø³ÙŠØªÙ… ØªØ¹Ø¨Ø¦ØªÙ‡ Ø¯ÙŠÙ†Ø§Ù…ÙŠÙƒÙŠØ§Ù‹ -->
</div>
</body>
</html>